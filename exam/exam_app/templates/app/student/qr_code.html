{% extends 'app/base.html' %}

{% block title %}QR Code และ Barcode การลงทะเบียนสอบ{% endblock %}

{% load static %}

{% block content %}
<div class="flex items-center justify-center min-h-screen bg-pink-50 py-12">
    <div class="bg-white shadow-2xl rounded-2xl p-8 max-w-lg w-full">
        <div class="flex justify-center mb-8">
            <img src="{% static 'src/images/sc.png' %}" alt="โรงเรียนศรีแก้วประชาสรรค์" class="w-40 h-30">
        </div>
        <h2 class="text-3xl font-bold text-center text-pink-700 mb-8">QR Code และ Barcode สำหรับนักเรียน: {{ student.user.get_full_name }}</h2>
        <div class="flex justify-center mb-8">
            {% if qr_code %}
                <div class="text-center">
                    <img src="{{ qr_code }}" alt="QR Code for Student" class="shadow-md rounded-lg w-40 h-40 mb-4">
                    <p><strong class="text-pink-700">เวลานับถอยหลัง (QR Code):</strong> <span id="countdown-qr"></span></p>
                </div>
            {% else %}
                <p class="text-red-500">Error generating QR code. Please try again or contact support.</p>
            {% endif %}
        </div>
        <div class="text-center mb-8">
            <canvas id="barcode" class="shadow-md rounded-lg mx-auto mb-4"></canvas>
            <p><strong class="text-pink-700">เวลานับถอยหลัง (Barcode):</strong> <span id="countdown-barcode"></span></p>
        </div>
        <div class="text-center">
            <p class="text-xl text-gray-800 font-semibold mb-4">รายละเอียดการสอบ:</p>
            <ul class="list-none space-y-4 text-left">
                {% for exam in exams_info %}
                <li class="p-4 bg-pink-100 rounded-lg shadow-md">
                    <p><strong class="text-pink-700">วิชา:</strong> {{ exam.subject_name }}</p>
                    <p><strong class="text-pink-700">รหัสวิชา:</strong> {{ exam.subject_code }}</p>
                    <p><strong class="text-pink-700">เริ่มสอบ:</strong> {{ exam.start_time }}</p>
                    <p><strong class="text-pink-700">สิ้นสุด:</strong> {{ exam.end_time }}</p>
                    <p><strong class="text-pink-700">ห้องสอบ:</strong> {{ exam.exam_room }}</p>
                    <p><strong class="text-pink-700">เวลานับถอยหลัง:</strong> <span id="countdown-{{ forloop.counter0 }}"></span></p>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        const examsData = JSON.parse('{{ exams_info_json|escapejs }}');
        let barcodeData = examsData.map(exam => `${exam.subject_code}: ${exam.start_time}-${exam.end_time}`).join(' | ');

        console.log('Barcode Data:', barcodeData); // Debugging: Check the generated data

        // Generate Barcode
        if (barcodeData) {
            JsBarcode("#barcode", barcodeData, {
                format: "CODE128",
                lineColor: "#000",
                width: 1,  // Reduced width for shorter barcode
                height: 40,  // Reduced height for a shorter barcode
                textMargin: 0,
                fontSize: 12, // Reduced font size
                displayValue: true
            });
        }

        // Generate QR Code
        const qrCodeData = '{{ qr_code|escapejs }}';
        if (qrCodeData) {
            new QRCode(document.getElementById("qrcode"), {
                text: qrCodeData,
                width: 128,
                height: 128
            });
        }

        // Countdown Timers
        examsData.forEach((exam, index) => {
            const startTime = new Date(exam.start_time);
            const endTime = new Date(exam.end_time);

            function updateCountdown() {
                const now = new Date();
                let distance = startTime - now;
                let countdownElement = document.getElementById(`countdown-${index}`);

                if (distance < 0) {
                    distance = endTime - now;
                    if (distance < 0) {
                        countdownElement.innerHTML = "00:00:00";
                        return;
                    }
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            setInterval(updateCountdown, 1000);
        });

        // QR Code Countdown
        function updateQrCountdown() {
            const now = new Date();
            let distance = new Date(examsData[0].end_time) - now;
            const countdownElement = document.getElementById('countdown-qr');

            if (distance < 0) {
                countdownElement.innerHTML = "00:00:00";
                return;
            }

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownElement.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        setInterval(updateQrCountdown, 1000);

        // Barcode Countdown
        function updateBarcodeCountdown() {
            const now = new Date();
            let distance = new Date(examsData[0].end_time) - now;
            const countdownElement = document.getElementById('countdown-barcode');

            if (distance < 0) {
                countdownElement.innerHTML = "00:00:00";
                return;
            }

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownElement.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        setInterval(updateBarcodeCountdown, 1000);

    } catch (error) {
        console.error('Error generating barcode or QR code:', error);
    }
});
</script>
{% endblock %}
    