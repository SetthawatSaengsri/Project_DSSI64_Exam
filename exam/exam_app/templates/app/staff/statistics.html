<!-- app/staff/statistics.html -->

{% extends "app/base.html" %}

{% block content %}
<div class="container mx-auto mt-10 max-w-7xl px-6 md:px-12">
    <h2 class="text-4xl font-bold text-indigo-700 text-center mb-8">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö</h2>

    <!-- üîπ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô -->
    <div class="mb-6 text-center">
        <label for="classFilter" class="text-lg font-semibold text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</label>
        <select id="classFilter" class="p-2 border border-gray-300 rounded-md">
            <option value="all">üìå ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
            {% for class_name in class_list %}
            <option value="{{ class_name }}">{{ class_name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- üîπ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-indigo-100 p-6 rounded-lg shadow-lg flex items-center">
            <div class="text-indigo-700 text-5xl">üë©‚Äçüè´</div>
            <div class="ml-4">
                <h3 class="text-xl font-semibold text-indigo-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π</h3>
                <p class="text-4xl font-bold text-gray-800 mt-2" id="teacher-count">{{ teacher_count }}</p>
            </div>
        </div>
        <div class="bg-yellow-100 p-6 rounded-lg shadow-lg flex items-center">
            <div class="text-yellow-700 text-5xl">üéì</div>
            <div class="ml-4">
                <h3 class="text-xl font-semibold text-yellow-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <p class="text-4xl font-bold text-gray-800 mt-2" id="student-count">{{ student_count }}</p>
            </div>
        </div>
        <div class="bg-green-100 p-6 rounded-lg shadow-lg flex items-center">
            <div class="text-green-700 text-5xl">üìñ</div>
            <div class="ml-4">
                <h3 class="text-xl font-semibold text-green-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3>
                <p class="text-4xl font-bold text-gray-800 mt-2" id="subject-count">{{ subject_count }}</p>
            </div>
        </div>
    </div>

    <!-- üîπ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö -->
    <div class="mt-10">
        <h3 class="text-2xl font-semibold text-gray-700 text-center mb-6">üìå ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold text-gray-700 text-center mb-4">üìä ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</h3>
                <canvas id="barChart"></canvas>
            </div>

            <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold text-gray-700 text-center mb-4">üìà ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- üé® Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let attendanceData = {{ attendance_data|safe }};
        let classFilter = document.getElementById("classFilter");
        let teacherCount = document.getElementById("teacher-count");
        let studentCount = document.getElementById("student-count");
        let subjectCount = document.getElementById("subject-count");

        function updateCharts(className) {
            let data = attendanceData[className] || attendanceData["all"];

            teacherCount.innerText = data.total_teachers;
            studentCount.innerText = data.total_students;
            subjectCount.innerText = data.total_subjects;

            // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            let onTime = data.on_time || 0;
            let late = data.late || 0;
            let absent = data.absent || 0;

            barChart.data.datasets[0].data = [onTime, late, absent];
            pieChart.data.datasets[0].data = [onTime, late, absent];

            barChart.update();
            pieChart.update();
        }

        let barCtx = document.getElementById("barChart").getContext("2d");
        let barChart = new Chart(barCtx, {
            type: "bar",
            data: {
                labels: ["‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤", "‡∏°‡∏≤‡∏™‡∏≤‡∏¢", "‡∏Ç‡∏≤‡∏î‡∏™‡∏≠‡∏ö"],
                datasets: [{
                    label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
                    data: [attendanceData["all"].on_time || 0, attendanceData["all"].late || 0, attendanceData["all"].absent || 0],
                    backgroundColor: ["#16a34a", "#facc15", "#dc2626"]
                }]
            },
            options: { responsive: true }
        });

        let pieCtx = document.getElementById("pieChart").getContext("2d");
        let pieChart = new Chart(pieCtx, {
            type: "pie",
            data: {
                labels: ["‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤", "‡∏°‡∏≤‡∏™‡∏≤‡∏¢", "‡∏Ç‡∏≤‡∏î‡∏™‡∏≠‡∏ö"],
                datasets: [{
                    data: [attendanceData["all"].on_time || 0, attendanceData["all"].late || 0, attendanceData["all"].absent || 0],
                    backgroundColor: ["#16a34a", "#facc15", "#dc2626"]
                }]
            },
            options: { responsive: true }
        });

        classFilter.addEventListener("change", function () {
            updateCharts(this.value);
        });
    });
</script>
{% endblock %}
