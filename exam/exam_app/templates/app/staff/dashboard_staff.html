{% extends "app/base.html" %}

{% block content %}
<div class="container mx-auto mt-10 max-w-7xl px-6 md:px-12">
    <h2 class="text-4xl font-bold text-indigo-700 text-center mb-12">ЁЯУК р╣Бр╕Фр╕Кр╕Ър╕нр╕гр╣Мр╕Фр╣Ар╕Ир╣Йр╕▓р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И</h2>

    <!-- ЁЯФ╣ р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕ар╕▓р╕Юр╕гр╕зр╕б -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {% for card in overview_cards %}
        <div class="bg-{{ card.color }}-100 p-6 rounded-2xl shadow-md flex items-center">
            <div class="text-{{ card.color }}-700 text-5xl">{{ card.icon }}</div>
            <div class="ml-5">
                <h3 class="text-xl font-semibold text-{{ card.color }}-700">{{ card.label }}</h3>
                <p class="text-4xl font-bold text-gray-800 mt-2" id="{{ card.label|slugify }}">{{ card.count }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ЁЯФ╣ р╕ер╕┤р╕Зр╕Бр╣Мр╕Ир╕▒р╕Фр╕Бр╕▓р╕г -->
    <div class="mt-14">
        <h3 class="text-2xl font-semibold text-gray-800 mb-6">ЁЯЫа р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕г</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <a href="{% url 'import_csv' %}" class="bg-blue-500 hover:bg-blue-600 text-white py-5 px-4 rounded-xl text-center font-medium shadow-md transition">ЁЯУВ р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕е CSV</a>
            <a href="{% url 'add_exam_subject' %}" class="bg-green-500 hover:bg-green-600 text-white py-5 px-4 rounded-xl text-center font-medium shadow-md transition">ЁЯУЪ р╣Ар╕Юр╕┤р╣Ир╕бр╕гр╕▓р╕вр╕зр╕┤р╕Кр╕▓</a>
            <a href="{% url 'exam_subjects_staff' %}" class="bg-purple-500 hover:bg-purple-600 text-white py-5 px-4 rounded-xl text-center font-medium shadow-md transition">ЁЯУЭ р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕зр╕┤р╕Кр╕▓</a>
        </div>
    </div>

    <!-- ЁЯФ╣ р╕кр╕Цр╕┤р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕нр╕Ъ -->
    <div class="mt-16">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">ЁЯУИ р╕кр╕Цр╕┤р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕нр╕Ъ</h3>

        <div class="flex flex-col md:flex-row justify-center items-center gap-6 mb-6">
            <div>
                <label for="academicYearFilter" class="font-medium text-gray-700 mr-2">р╕Ыр╕╡р╕Бр╕▓р╕гр╕ир╕╢р╕Бр╕йр╕▓:</label>
                <select id="academicYearFilter" class="p-2 border border-gray-300 rounded-md">
                    <option value="all">ЁЯУМ р╕Чр╕╕р╕Бр╕Ыр╕╡р╕Бр╕▓р╕гр╕ир╕╢р╕Бр╕йр╕▓</option>
                    {% for year in year_list %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="classFilter" class="font-medium text-gray-700 mr-2">р╕гр╕░р╕Фр╕▒р╕Ър╕Кр╕▒р╣Йр╕Щ:</label>
                <select id="classFilter" class="p-2 border border-gray-300 rounded-md">
                    <option value="all">ЁЯУМ р╕Чр╕╕р╕Бр╕гр╕░р╕Фр╕▒р╕Ър╕Кр╕▒р╣Йр╕Щ</option>
                    {% for class_name in class_list %}
                    <option value="{{ class_name }}">{{ class_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h4 class="text-center text-lg font-semibold text-gray-700 mb-4">ЁЯУК р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕Вр╣Йр╕▓р╕кр╕нр╕Ъ</h4>
                <canvas id="barChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h4 class="text-center text-lg font-semibold text-gray-700 mb-4">ЁЯУИ р╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕нр╕Ъ</h4>
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let attendanceData = {{ attendance_data|safe }};

        const classFilter = document.getElementById("classFilter");
        const yearFilter = document.getElementById("academicYearFilter");
        const teacherCount = document.getElementById("р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕гр╕╣");
        const studentCount = document.getElementById("р╕Ир╕│р╕Щр╕зр╕Щр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ");
        const subjectCount = document.getElementById("р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕зр╕┤р╕Кр╕▓");

        function updateCharts(className) {
            let data = attendanceData[className] || attendanceData["all"];
            teacherCount.innerText = data.total_teachers;
            studentCount.innerText = data.total_students;
            subjectCount.innerText = data.total_subjects;
            let onTime = data.on_time || 0;
            let late = data.late || 0;
            let absent = data.absent || 0;
            barChart.data.datasets[0].data = [onTime, late, absent];
            pieChart.data.datasets[0].data = [onTime, late, absent];
            barChart.update();
            pieChart.update();
        }

        const barChart = new Chart(document.getElementById("barChart"), {
            type: "bar",
            data: {
                labels: ["р╕бр╕▓р╕Хр╕гр╕Зр╣Ар╕зр╕ер╕▓", "р╕бр╕▓р╕кр╕▓р╕в", "р╕Вр╕▓р╕Фр╕кр╕нр╕Ъ"],
                datasets: [{
                    label: "р╕Ир╕│р╕Щр╕зр╕Щр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ",
                    data: [attendanceData["all"].on_time || 0, attendanceData["all"].late || 0, attendanceData["all"].absent || 0],
                    backgroundColor: ["#16a34a", "#facc15", "#dc2626"]
                }]
            },
            options: { responsive: true }
        });

        const pieChart = new Chart(document.getElementById("pieChart"), {
            type: "pie",
            data: {
                labels: ["р╕бр╕▓р╕Хр╕гр╕Зр╣Ар╕зр╕ер╕▓", "р╕бр╕▓р╕кр╕▓р╕в", "р╕Вр╕▓р╕Фр╕кр╕нр╕Ъ"],
                datasets: [{
                    data: [attendanceData["all"].on_time || 0, attendanceData["all"].late || 0, attendanceData["all"].absent || 0],
                    backgroundColor: ["#16a34a", "#facc15", "#dc2626"]
                }]
            },
            options: { responsive: true }
        });

        classFilter.addEventListener("change", () => updateCharts(classFilter.value));
        });
</script>
{% endblock %}
