{% extends 'app/base.html' %} 

{% block title %}Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö{% endblock %}

{% block current_page %}import-students{% endblock %}

{% block page_title %}Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô{% endblock %}
{% block page_subtitle %}‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏´‡∏£‡∏∑‡∏≠ CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å{% endblock %}

{% block extra_css %}
<style>
    /* ==================== CUSTOM COMPONENTS ==================== */
    .upload-area {
        transition: all 0.3s ease;
        border: 2px dashed rgba(59, 130, 246, 0.3);
    }

    .upload-area:hover {
        border-color: rgba(59, 130, 246, 0.6);
        background: rgba(59, 130, 246, 0.05);
    }

    .upload-area.dragover {
        border-color: rgba(59, 130, 246, 1);
        background: rgba(59, 130, 246, 0.1);
        transform: scale(1.02);
    }

    .progress-bar {
        transition: width 0.3s ease;
        background: linear-gradient(45deg, 
            rgba(16, 185, 129, 1) 25%, 
            rgba(52, 211, 153, 1) 25%, 
            rgba(52, 211, 153, 1) 50%, 
            rgba(16, 185, 129, 1) 50%, 
            rgba(16, 185, 129, 1) 75%, 
            rgba(52, 211, 153, 1) 75%);
        background-size: 20px 20px;
        animation: progress-stripes 1s linear infinite;
    }

    @keyframes progress-stripes {
        0% { background-position: 0 0; }
        100% { background-position: 20px 0; }
    }

    @keyframes pulse-success {
        0%, 100% { 
            background: rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        50% { 
            background: rgba(34, 197, 94, 0.4);
            box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
    }

    .animate-pulse-success {
        animation: pulse-success 2s infinite;
    }

    /* ==================== FILE INPUT STYLING ==================== */
    .file-input {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- ==================== HEADER SECTION ==================== -->
<div class="mb-12 text-center space-y-6">
    <div class="animate-slide-up">
        <h2 class="text-4xl lg:text-5xl font-bold font-kanit mb-4">
            <span class="text-gradient-green">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
        </h2>
        <p class="text-xl text-slate-300 font-prompt">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏´‡∏£‡∏∑‡∏≠ CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</p>
    </div>
    <div class="flex justify-center">
        <div class="w-32 h-1 bg-gradient-to-r from-green-500 via-emerald-500 to-cyan-500 rounded-full"></div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <!-- ==================== UPLOAD SECTION ==================== -->
    <div class="glass rounded-3xl p-8 border border-white/20">
        <div class="text-center mb-8">
            <h3 class="text-2xl font-bold font-kanit mb-4">
                <span class="text-gradient-green">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </h3>
            <p class="text-slate-300 font-prompt">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx, .xls) ‡∏´‡∏£‡∏∑‡∏≠ CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        </div>

        <!-- Upload Form -->
        <form method="post" enctype="multipart/form-data" id="importForm">
            {% csrf_token %}
            
            <!-- File Upload Area -->
            <div class="upload-area rounded-2xl p-8 text-center mb-6" id="uploadArea">
                <div class="mb-6">
                    <div class="w-20 h-20 bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-float shadow-glow-green">
                        <i class="fas fa-cloud-upload-alt text-3xl text-white"></i>
                    </div>
                    <h4 class="text-xl font-bold mb-2 font-kanit">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h4>
                    <p class="text-slate-400 mb-4">‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                </div>
                
                <input type="file" name="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" required>
                <button type="button" onclick="document.getElementById('fileInput').click()" class="px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-xl transition-all duration-300 transform hover:scale-105 font-semibold">
                    <i class="fas fa-folder-open mr-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                </button>
                
                <!-- File Info Display -->
                <div id="fileInfo" class="hidden mt-4 p-4 glass-dark rounded-xl">
                    <div class="flex items-center justify-center space-x-3">
                        <i class="fas fa-file-excel text-green-400 text-2xl"></i>
                        <div class="text-left">
                            <p class="font-medium" id="fileName"></p>
                            <p class="text-sm text-slate-400" id="fileSize"></p>
                        </div>
                        <button type="button" onclick="removeFile()" class="ml-4 text-red-400 hover:text-red-300 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Options -->
            <div class="space-y-4 mb-6">
                <div class="flex items-center space-x-3">
                    <input type="checkbox" name="overwrite_existing" id="overwrite" class="w-4 h-4 text-green-500 bg-slate-700 border-slate-600 rounded focus:ring-green-500">
                    <label for="overwrite" class="text-slate-300">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</label>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="progressContainer" class="hidden mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-slate-300">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î...</span>
                    <span class="text-sm text-slate-400" id="progressText">0%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2">
                    <div class="progress-bar h-2 rounded-full" id="progressBar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="w-full px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-xl transition-all duration-300 transform hover:scale-105 font-semibold font-kanit text-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                <i class="fas fa-upload mr-2"></i>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </form>
    </div>

    <!-- ==================== INSTRUCTIONS & TEMPLATE ==================== -->
    <div class="space-y-8">
        
        <!-- Download Template -->
        <div class="glass rounded-3xl p-8 border border-white/20">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold font-kanit mb-4">
                    <span class="text-gradient">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</span>
                </h3>
                <p class="text-slate-300 font-prompt">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            </div>

            <div class="space-y-4">
                <a href="/download/template/student/" class="block w-full px-6 py-4 glass border border-blue-500/30 hover:border-blue-500/50 hover:bg-blue-500/10 rounded-xl transition-all duration-300 group">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                <i class="fas fa-file-excel text-white text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold font-kanit">Template Excel</h4>
                                <p class="text-sm text-slate-400">‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á .xlsx ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>
                            </div>
                        </div>
                        <i class="fas fa-download text-blue-400 group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </a>

                <a href="/export/users/student/" class="block w-full px-6 py-4 glass border border-green-500/30 hover:border-green-500/50 hover:bg-green-500/10 rounded-xl transition-all duration-300 group">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                <i class="fas fa-download text-white text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold font-kanit">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                                <p class="text-sm text-slate-400">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                            </div>
                        </div>
                        <i class="fas fa-external-link-alt text-green-400 group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </a>
            </div>
        </div>

        <!-- Instructions -->
        <div class="glass rounded-3xl p-8 border border-white/20">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold font-kanit mb-4">
                    <span class="text-gradient-orange">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                </h3>
            </div>

            <div class="space-y-4">
                <div class="flex items-start space-x-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                        <span class="text-white text-sm font-bold">1</span>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</h4>
                        <p class="text-slate-400 text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                    </div>
                </div>

                <div class="flex items-start space-x-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                        <span class="text-white text-sm font-bold">2</span>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                        <p class="text-slate-400 text-sm">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                    </div>
                </div>

                <div class="flex items-start space-x-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                        <span class="text-white text-sm font-bold">3</span>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</h4>
                        <p class="text-slate-400 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÜ</p>
                    </div>
                </div>

                <div class="flex items-start space-x-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                        <span class="text-white text-sm font-bold">4</span>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h4>
                        <p class="text-slate-400 text-sm">‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>
                    </div>
                </div>
            </div>

            <!-- Required Fields -->
            <div class="mt-6 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                <div class="flex items-center space-x-2 mb-3">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    <h4 class="font-bold text-yellow-400">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>username (Username)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>password (Password)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>student_id (‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>first_name (‡∏ä‡∏∑‡πà‡∏≠)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>last_name (‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>email (‡∏≠‡∏µ‡πÄ‡∏°‡∏•)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>student_class (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-asterisk text-red-400 text-xs"></i>
                        <span>student_number (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== SUCCESS MODAL ==================== -->
<div id="successModal" class="fixed inset-0 hidden bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="modal-content glass-dark rounded-3xl p-8 w-full max-w-md border border-white/20 transform scale-75 opacity-0 transition-all duration-300">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse-success">
                <i class="fas fa-check text-2xl text-white"></i>
            </div>
            <h3 class="text-xl font-bold font-kanit mb-2 text-green-400">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p class="text-slate-400 font-prompt" id="successMessage">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
        
        <button onclick="closeSuccessModal()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-xl transition-all duration-300">
            <i class="fas fa-check mr-2"></i>‡∏ï‡∏Å‡∏•‡∏á
        </button>
    </div>
</div>

<!-- Django Messages -->
{% if messages %}
    <div id="djangoMessages" class="hidden">
        {% for message in messages %}
            <div class="message" data-type="{{ message.tags }}" data-message="{{ message }}"></div>
        {% endfor %}
    </div>
{% endif %}
{% block extra_js %}{% endblock %}
<script>
    // ==================== GLOBAL VARIABLES ====================
    let selectedFile = null;
    let isUploading = false;

    // ==================== FILE HANDLING ====================
    function initializeFileHandling() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        // File input change event
        fileInput.addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0]);
        });

        // Drag and drop events
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // Click to select file
        uploadArea.addEventListener('click', function(e) {
            if (e.target === uploadArea || e.target.closest('.upload-area')) {
                fileInput.click();
            }
        });
    }

    function handleFileSelect(file) {
        if (!file) return;

        // Validate file type
        const allowedTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
            'application/vnd.ms-excel', // .xls
            'text/csv' // .csv
        ];

        if (!allowedTypes.includes(file.type) && !file.name.toLowerCase().match(/\.(xlsx|xls|csv)$/)) {
            showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .xlsx, .xls ‡∏´‡∏£‡∏∑‡∏≠ .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
            return;
        }

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤', 'error');
            return;
        }

        selectedFile = file;
        
        // Update UI
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('fileInfo').classList.remove('hidden');
        
        // Update file input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('fileInput').files = dataTransfer.files;

        showNotification('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + file.name, 'success');
    }

    function removeFile() {
        selectedFile = null;
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('fileInput').value = '';
        showNotification('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ==================== FORM SUBMISSION ====================
    function initializeFormSubmission() {
        const form = document.getElementById('importForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedFile) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î', 'error');
                return;
            }

            if (isUploading) {
                showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'warning');
                return;
            }

            startUpload();
        });
    }

    function startUpload() {
        isUploading = true;
        
        // Update UI
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('progressContainer').classList.remove('hidden');
        showLoading();
        
        // Create FormData
        const formData = new FormData(document.getElementById('importForm'));
        
        // Create XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        // Progress tracking
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                updateProgress(percentComplete);
            }
        });
        
        // Upload complete
        xhr.addEventListener('load', function() {
            hideLoading();
            isUploading = false;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('progressContainer').classList.add('hidden');
            
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    handleUploadSuccess(response);
                } catch (e) {
                    // If not JSON, it's likely a redirect (successful form submission)
                    showSuccessModal('‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } else {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        });
        
        // Upload error
        xhr.addEventListener('error', function() {
            hideLoading();
            isUploading = false;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('progressContainer').classList.add('hidden');
            showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        });
        
        // Start upload
        xhr.open('POST', window.location.href);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
        
        showNotification('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î...', 'info');
    }

    function updateProgress(percent) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        progressBar.style.width = percent + '%';
        progressText.textContent = Math.round(percent) + '%';
    }

    function handleUploadSuccess(response) {
        if (response.success) {
            showSuccessModal(response.message || '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        } else {
            showNotification(response.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        }
    }

    // ==================== SUCCESS MODAL ====================
    function showSuccessModal(message) {
        const modal = document.getElementById('successModal');
        const modalContent = modal.querySelector('.modal-content');
        const messageElement = document.getElementById('successMessage');
        
        messageElement.textContent = message;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        setTimeout(() => {
            modalContent.style.transform = 'scale(1)';
            modalContent.style.opacity = '1';
        }, 10);
    }

    function closeSuccessModal() {
        const modal = document.getElementById('successModal');
        const modalContent = modal.querySelector('.modal-content');
        
        modalContent.style.transform = 'scale(0.75)';
        modalContent.style.opacity = '0';
        
        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }, 300);
    }

    // ==================== DJANGO MESSAGES HANDLER ====================
    function handleDjangoMessages() {
        const messagesContainer = document.getElementById('djangoMessages');
        if (messagesContainer) {
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach(messageEl => {
                const type = messageEl.getAttribute('data-type');
                const message = messageEl.getAttribute('data-message');
                
                // Convert Django message tags to notification types
                let notificationType = 'info';
                if (type === 'success') notificationType = 'success';
                else if (type === 'error') notificationType = 'error';
                else if (type === 'warning') notificationType = 'warning';
                
                setTimeout(() => {
                    showNotification(message, notificationType);
                }, 500);
            });
        }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', function(e) {
        // ESC key closes modals
        if (e.key === 'Escape') {
            if (!document.getElementById('successModal').classList.contains('hidden')) {
                closeSuccessModal();
            }
        }
        
        // Ctrl/Cmd + U for upload
        if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
            e.preventDefault();
            document.getElementById('fileInput').click();
        }
    });

    // ==================== ACCESSIBILITY ENHANCEMENTS ====================
    function setupAccessibility() {
        // Add focus indicators
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-nav');
            }
        });

        document.addEventListener('mousedown', function() {
            document.body.classList.remove('keyboard-nav');
        });
    }

    // ==================== PAGE INITIALIZATION ====================
    function initializePage() {
        console.log('üéØ Student Import page loaded successfully!');
        
        // Initialize all features
        initializeFileHandling();
        initializeFormSubmission();
        setupAccessibility();
        handleDjangoMessages();
        
        // Show welcome message
        setTimeout(() => {
            showNotification('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'info');
        }, 1000);
        
        // Keyboard shortcuts info
        setTimeout(() => {
            showNotification('üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡πÉ‡∏ä‡πâ Ctrl+U ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô', 'info', 6000);
        }, 3000);
    }
</script>
{% endblock %}