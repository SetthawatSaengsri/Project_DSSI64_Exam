{% extends 'app/base.html' %}
{% load static %}

{% block title %}เพิ่มรายวิชาสอบ | Exam Manager{% endblock %}

{% block page_title %}เพิ่มรายวิชาสอบ{% endblock %}
{% block page_subtitle %}จัดการข้อมูลการสอบแบบครบวงจร{% endblock %}

{% block current_page %}add-exam{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">
    <!-- Header Section -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div
                class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                <i class="fas fa-plus text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">
                    เพิ่มรายวิชาสอบ
                </h1>
                <p class="text-slate-400">สร้างรายการสอบใหม่พร้อมจัดห้องและครูอัตโนมัติ</p>
            </div>
        </div>
        <a href="{% url 'exam_subjects' %}"
            class="inline-flex items-center px-6 py-3 rounded-xl glass-dark hover:bg-slate-700/50 text-white transition-all duration-300 border border-slate-600">
            <i class="fas fa-arrow-left mr-3"></i>
            กลับไปหน้ารายการ
        </a>
    </div>

    <form method="post" action="{% url 'add_exam_subject' %}" class="space-y-8" id="add-exam-form">
        {% csrf_token %}

        <!-- ข้อมูลวิชา -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-book text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">ข้อมูลรายวิชา</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-tag mr-2 text-purple-400"></i>ชื่อวิชา
                    </label>
                    <input type="text" name="subject_name" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300"
                        placeholder="เช่น คณิตศาสตร์พื้นฐาน">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-hashtag mr-2 text-purple-400"></i>รหัสวิชา
                    </label>
                    <input type="text" name="subject_code" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300"
                        placeholder="เช่น MATH101">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-calendar-alt mr-2 text-purple-400"></i>ปีการศึกษา
                    </label>
                    <input type="text" name="academic_year" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300"
                        placeholder="เช่น 2568">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-graduation-cap mr-2 text-purple-400"></i>ภาคเรียน
                    </label>
                    <select name="term" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                        <option value="">-- เลือกภาคเรียน --</option>
                        <option value="1">เทอม 1</option>
                        <option value="2">เทอม 2</option>
                        <option value="3">เทอม 3</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-calendar mr-2 text-purple-400"></i>วันสอบ
                    </label>
                    <input type="date" name="exam_date" id="exam_date" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-clock mr-2 text-purple-400"></i>เวลาเริ่มสอบ
                    </label>
                    <input type="time" name="start_time" id="start_time" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-clock mr-2 text-purple-400"></i>เวลาสิ้นสุดสอบ
                    </label>
                    <input type="time" name="end_time" id="end_time" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                </div>
            </div>
        </div>

        <!-- กลุ่มนักเรียน -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-users text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">กลุ่มนักเรียน</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-layer-group mr-2 text-emerald-400"></i>ระดับชั้น
                    </label>
                    <select name="student_class" id="student_class" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all duration-300">
                        <option value="">-- เลือกระดับชั้น --</option>
                        {% for c in classes %}
                        {% if c %}<option value="{{ c }}">{{ c }}</option>{% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="md:col-span-2">
                    <div class="flex items-center h-12 px-4 py-3 bg-slate-900/40 border border-slate-700 rounded-xl">
                        <i class="fas fa-info-circle mr-3 text-emerald-400"></i>
                        <span class="text-slate-300" id="class-count">เลือกระดับชั้นเพื่อดูจำนวนนักเรียน</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ส่วนห้องสอบ -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-door-open text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">ห้องสอบ</h2>
            </div>

            <div class="space-y-6">
                <!-- ตัวเลือกจัดห้องอัตโนมัติ -->
                <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-600">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="room_assignment_type" value="auto" id="auto_assign_room"
                            class="w-5 h-5 text-yellow-500 bg-slate-700 border-slate-600 rounded focus:ring-yellow-500">
                        <input type="hidden" name="room_assignment_type" value="manual"
                            id="room_assignment_type_hidden">
                        <div class="ml-3">
                            <span class="text-white font-medium">
                                <i class="fas fa-magic mr-2 text-yellow-400"></i>จัดห้องอัตโนมัติ
                            </span>
                            <p class="text-slate-400 text-sm mt-1">ระบบจะค้นหาและจัดห้องที่เหมาะสมให้โดยอัตโนมัติ</p>
                        </div>
                    </label>
                </div>

                <!-- ส่วนเลือกห้องด้วยตนเอง -->
                <div id="manual-room-section" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-building mr-2 text-yellow-400"></i>อาคาร
                            </label>
                            <select id="building"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300">
                                <option value="">-- เลือกอาคาร --</option>
                                {% for building in buildings %}
                                <option value="{{ building.id }}">{{ building.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-door-closed mr-2 text-yellow-400"></i>ห้องสอบ
                            </label>
                            <select name="room" id="room"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300">
                                <option value="">-- เลือกอาคารก่อน --</option>
                            </select>
                        </div>
                    </div>

                    <!-- แสดงข้อมูลห้องที่เลือก -->
                    <div id="room-info" class="hidden bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                            <span class="text-blue-100 font-medium">ข้อมูลห้องที่เลือก</span>
                        </div>
                        <div id="room-details" class="text-slate-300 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ส่วนครูคุมสอบ -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-chalkboard-teacher text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">ครูคุมสอบ</h2>
            </div>

            <div class="space-y-6">
                <!-- ตัวเลือกจัดครูอัตโนมัติ -->
                <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-600">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="teacher_assignment_type" value="auto" id="auto_assign_teachers"
                            class="w-5 h-5 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-500">
                        <input type="hidden" name="teacher_assignment_type" value="manual"
                            id="teacher_assignment_type_hidden">
                        <div class="ml-3">
                            <span class="text-white font-medium">
                                <i class="fas fa-magic mr-2 text-cyan-400"></i>จัดครูอัตโนมัติ
                            </span>
                            <p class="text-slate-400 text-sm mt-1">ระบบจะค้นหาและจัดครูที่ว่างให้โดยอัตโนมัติ</p>
                        </div>
                    </label>
                </div>

                <!-- ส่วนเลือกครูด้วยตนเอง -->
                <div id="manual-teacher-section" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-user-tie mr-2 text-cyan-400"></i>ครูคุมสอบหลัก
                            </label>
                            <select name="invigilator" id="invigilator"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all duration-300">
                                <option value="">-- เลือกครู --</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.user.get_full_name }} ({{ teacher.teacher_id
                                    }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-user-check mr-2 text-cyan-400"></i>ครูคุมสอบสำรอง
                                <span class="text-xs text-slate-500">(ไม่บังคับ)</span>
                            </label>
                            <select name="secondary_invigilator" id="secondary_invigilator"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all duration-300">
                                <option value="">-- ไม่ระบุ --</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.user.get_full_name }} ({{ teacher.teacher_id
                                    }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ปุ่มบันทึก -->
        <div class="flex items-center justify-between pt-8">
            <button type="reset"
                class="inline-flex items-center px-8 py-3 rounded-xl glass-dark hover:bg-slate-700/50 text-white font-medium transition-all duration-300 border border-slate-600">
                <i class="fas fa-eraser mr-3"></i>
                ล้างค่า
            </button>
            <div class="flex items-center space-x-4">
                <button type="button" onclick="previewForm()"
                    class="inline-flex items-center px-8 py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-medium transition-all duration-300 shadow-lg">
                    <i class="fas fa-eye mr-3"></i>
                    ตัวอย่าง
                </button>
                <button type="submit"
                    class="inline-flex items-center px-8 py-3 rounded-xl bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold transition-all duration-300 shadow-xl">
                    <i class="fas fa-save mr-3"></i>
                    บันทึกวิชา
                </button>
            </div>
        </div>
    </form>
</div>
{% block extra_js %}{% endblock %}
<script>
    
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Initializing Add Exam Subject form...');

        // Helper functions for DOM selection
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

        // ============= การจัดการ Checkbox อัตโนมัติ =============

        // จัดการ checkbox ห้องอัตโนมัติ
        const autoRoomCheckbox = $('#auto_assign_room');
        const manualRoomSection = $('#manual-room-section');
        const roomTypeHidden = $('#room_assignment_type_hidden');

        if (autoRoomCheckbox) {
            autoRoomCheckbox.addEventListener('change', function () {
                console.log('Auto room checkbox changed:', this.checked);

                if (this.checked) {
                    manualRoomSection.style.opacity = '0.5';
                    manualRoomSection.style.pointerEvents = 'none';
                    roomTypeHidden.value = 'auto';

                    // ล้างค่าที่เลือกไว้
                    $('#building').value = '';
                    $('#room').innerHTML = '<option value="">-- เลือกอาคารก่อน --</option>';
                    $('#room-info').classList.add('hidden');
                } else {
                    manualRoomSection.style.opacity = '1';
                    manualRoomSection.style.pointerEvents = 'auto';
                    roomTypeHidden.value = 'manual';
                }
            });
        }

        // จัดการ checkbox ครูอัตโนมัติ
        const autoTeacherCheckbox = $('#auto_assign_teachers');
        const manualTeacherSection = $('#manual-teacher-section');
        const teacherTypeHidden = $('#teacher_assignment_type_hidden');

        if (autoTeacherCheckbox) {
            autoTeacherCheckbox.addEventListener('change', function () {
                console.log('Auto teacher checkbox changed:', this.checked);

                if (this.checked) {
                    manualTeacherSection.style.opacity = '0.5';
                    manualTeacherSection.style.pointerEvents = 'none';
                    teacherTypeHidden.value = 'auto';

                    // ล้างค่าที่เลือกไว้
                    $('#invigilator').value = '';
                    $('#secondary_invigilator').value = '';
                } else {
                    manualTeacherSection.style.opacity = '1';
                    manualTeacherSection.style.pointerEvents = 'auto';
                    teacherTypeHidden.value = 'manual';
                }
            });
        }

        // ============= การจัดการข้อมูลนักเรียน =============

        const studentClassSelect = $('#student_class');
        const classCountElement = $('#class-count');

        if (studentClassSelect && classCountElement) {
            studentClassSelect.addEventListener('change', async (e) => {
                const selectedClass = e.target.value;
                console.log('Student class changed:', selectedClass);

                if (!selectedClass) {
                    classCountElement.textContent = 'เลือกระดับชั้นเพื่อดูจำนวนนักเรียน';
                    return;
                }

                classCountElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...';

                try {
                    const url = `/ajax/class-students-count/?class=${encodeURIComponent(selectedClass)}`;
                    console.log('Fetching student count from:', url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                    console.log('Student count response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Student count data:', data);

                    if (data.success) {
                        classCountElement.innerHTML = `<i class="fas fa-users mr-2 text-emerald-400"></i>นักเรียนทั้งหมด: <span class="font-semibold text-emerald-400">${data.count}</span> คน`;
                        showNotification(`พบนักเรียนในชั้น ${selectedClass} จำนวน ${data.count} คน`, 'success', 3000);
                    } else {
                        classCountElement.textContent = 'ไม่สามารถโหลดข้อมูลได้';
                        showNotification(data.error || 'เกิดข้อผิดพลาดในการโหลดข้อมูลนักเรียน', 'error');
                    }
                } catch (err) {
                    console.error('Error loading student count:', err);
                    classCountElement.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
                    showNotification('ไม่สามารถโหลดจำนวนนักเรียนได้', 'error');
                }
            });
        }

        // ============= การจัดการห้องสอบ =============

        const buildingSelect = $('#building');
        const roomSelect = $('#room');
        const roomInfo = $('#room-info');
        const roomDetails = $('#room-details');

        // เมื่อเลือกอาคาร -> โหลดรายการห้อง
        if (buildingSelect && roomSelect) {
            buildingSelect.addEventListener('change', async (e) => {
                const buildingId = e.target.value;
                console.log('🏢 Building selected:', buildingId);

                // ซ่อนข้อมูลห้อง
                if (roomInfo) roomInfo.classList.add('hidden');

                if (!buildingId) {
                    roomSelect.innerHTML = '<option value="">-- เลือกอาคารก่อน --</option>';
                    roomSelect.disabled = false;
                    return;
                }

                // แสดง loading state
                roomSelect.innerHTML = '<option value="">กำลังโหลดห้อง...</option>';
                roomSelect.disabled = true;

                try {
                    // แก้ไข URL ให้ตรงกับ urls.py
                    const url = `/ajax/rooms/?building_id=${encodeURIComponent(buildingId)}`;
                    console.log('📄 Fetching rooms from:', url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                    console.log('📡 Response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Response error:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('📊 Response data:', data);

                    // รีเซ็ตห้อง
                    roomSelect.innerHTML = '<option value="">-- เลือกห้อง --</option>';
                    roomSelect.disabled = false;

                    if (data.success && Array.isArray(data.rooms)) {
                        console.log(`✅ Found ${data.rooms.length} rooms`);

                        if (data.rooms.length === 0) {
                            roomSelect.innerHTML = '<option value="">-- ไม่มีห้องในอาคารนี้ --</option>';
                            showNotification('ไม่มีห้องในอาคารที่เลือก', 'warning');
                            return;
                        }

                        // เพิ่มห้องใน dropdown
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.id;
                            option.textContent = `ห้อง ${room.name} (จุ ${room.capacity} คน)`;

                            // เพิ่ม data attributes สำหรับใช้ภายหลัง
                            option.dataset.capacity = room.capacity;
                            option.dataset.buildingName = room.building_name || data.building_name || '';
                            option.dataset.roomName = room.name;
                            option.dataset.fullName = room.full_name || `${room.building_name} ห้อง ${room.name}`;

                            roomSelect.appendChild(option);
                        });

                        showNotification(`โหลดห้องสำเร็จ ${data.rooms.length} ห้อง`, 'success', 2000);

                    } else {
                        console.error('❌ Invalid response format:', data);
                        roomSelect.innerHTML = '<option value="">-- เกิดข้อผิดพลาด --</option>';

                        const errorMsg = data.error || 'รูปแบบข้อมูลไม่ถูกต้อง';
                        showNotification(`เกิดข้อผิดพลาด: ${errorMsg}`, 'error');
                    }

                } catch (error) {
                    console.error('💥 Error loading rooms:', error);
                    roomSelect.innerHTML = '<option value="">-- เกิดข้อผิดพลาดในการโหลด --</option>';
                    roomSelect.disabled = false;
                    showNotification(`ไม่สามารถโหลดรายการห้องได้: ${error.message}`, 'error');
                }
            });
        }

        // เมื่อเลือกห้อง -> แสดงข้อมูลห้อง
        if (roomSelect && roomInfo && roomDetails) {
            roomSelect.addEventListener('change', function (e) {
                const selectedOption = e.target.options[e.target.selectedIndex];
                console.log('🚪 Room selected:', selectedOption.value);

                if (selectedOption.value && selectedOption.dataset.capacity) {
                    const capacity = selectedOption.dataset.capacity;
                    const buildingName = selectedOption.dataset.buildingName;
                    const roomName = selectedOption.dataset.roomName;
                    const fullName = selectedOption.dataset.fullName || selectedOption.textContent;

                    roomDetails.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <i class="fas fa-building text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">อาคาร:</span>
                            <span class="ml-2 text-white">${buildingName}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-users text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">ความจุ:</span>
                            <span class="ml-2 text-white">${capacity} คน</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-door-open text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">ชื่อห้อง:</span>
                            <span class="ml-2 text-white">${roomName}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">ชื่อเต็ม:</span>
                            <span class="ml-2 text-white">${fullName}</span>
                        </div>
                    </div>
                `;
                    roomInfo.classList.remove('hidden');
                    showNotification(`เลือกห้อง ${fullName} (ความจุ ${capacity} คน)`, 'info', 2000);
                } else {
                    roomInfo.classList.add('hidden');
                }
            });
        }

        // ============= การป้องกันครูคนเดียวกัน =============

        const primaryTeacherSelect = $('#invigilator');
        const secondaryTeacherSelect = $('#secondary_invigilator');

        if (primaryTeacherSelect && secondaryTeacherSelect) {
            primaryTeacherSelect.addEventListener('change', () => {
                const primaryId = primaryTeacherSelect.value;
                console.log('Primary teacher selected:', primaryId);

                // เปิด/ปิด option ใน secondary teacher
                Array.from(secondaryTeacherSelect.options).forEach(option => {
                    if (option.value && option.value === primaryId) {
                        option.disabled = true;
                        option.style.color = '#64748b';
                    } else {
                        option.disabled = false;
                        option.style.color = '';
                    }
                });

                // รีเซ็ตค่าครูสำรองถ้าเลือกครูคนเดียวกัน
                if (secondaryTeacherSelect.value === primaryId) {
                    secondaryTeacherSelect.value = '';
                    showNotification('ครูสำรองจะต้องเป็นคนที่แตกต่างจากครูหลัก', 'warning');
                }
            });
        }

        // ============= การตรวจสอบข้อมูล =============

        // ตรวจสอบเวลา
        const startTimeInput = $('#start_time');
        const endTimeInput = $('#end_time');

        function validateTime() {
            if (startTimeInput && endTimeInput) {
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;

                if (startTime && endTime && startTime >= endTime) {
                    endTimeInput.classList.add('border-red-500');
                    startTimeInput.classList.add('border-red-500');
                    showNotification('เวลาเริ่มสอบต้องมาก่อนเวลาสิ้นสุดสอบ', 'warning');
                    return false;
                } else {
                    endTimeInput.classList.remove('border-red-500');
                    startTimeInput.classList.remove('border-red-500');
                    return true;
                }
            }
            return true;
        }

        if (startTimeInput) {
            startTimeInput.addEventListener('change', validateTime);
        }
        if (endTimeInput) {
            endTimeInput.addEventListener('change', validateTime);
        }

        // ============= การส่งฟอร์ม =============

        const examForm = $('#add-exam-form');
        if (examForm) {
            examForm.addEventListener('submit', (e) => {
                console.log('📝 Form submission started...');

                // ตรวจสอบเวลา
                if (!validateTime()) {
                    e.preventDefault();
                    endTimeInput.focus();
                    return false;
                }

                // ตรวจสอบว่าเลือกครูคนเดียวกันหรือไม่
                const primaryTeacher = primaryTeacherSelect?.value;
                const secondaryTeacher = secondaryTeacherSelect?.value;

                if (primaryTeacher && secondaryTeacher && primaryTeacher === secondaryTeacher) {
                    e.preventDefault();
                    showNotification('ครูคุมสอบหลักและครูคุมสอบสำรองต้องเป็นคนละคน', 'error');
                    secondaryTeacherSelect.focus();
                    return false;
                }

                // ตรวจสอบการเลือกห้องสอบ (ถ้าไม่ใช่อัตโนมัติ)
                const isAutoRoom = autoRoomCheckbox?.checked;
                if (!isAutoRoom && roomSelect && !roomSelect.value) {
                    e.preventDefault();
                    showNotification('กรุณาเลือกห้องสอบ หรือเปิดใช้งานการจัดห้องอัตโนมัติ', 'error');
                    roomSelect.focus();
                    return false;
                }

                // ตรวจสอบการเลือกครูคุมสอบ (ถ้าไม่ใช่อัตโนมัติ)
                const isAutoTeacher = autoTeacherCheckbox?.checked;
                if (!isAutoTeacher && primaryTeacherSelect && !primaryTeacherSelect.value) {
                    e.preventDefault();
                    showNotification('กรุณาเลือกครูคุมสอบหลัก หรือเปิดใช้งานการจัดครูอัตโนมัติ', 'error');
                    primaryTeacherSelect.focus();
                    return false;
                }

                // ตรวจสอบวันที่สอบ (ต้องไม่เป็นวันที่ผ่านมาแล้ว)
                const examDateInput = $('#exam_date');
                if (examDateInput && examDateInput.value) {
                    const examDate = new Date(examDateInput.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (examDate < today) {
                        e.preventDefault();
                        showNotification('วันที่สอบต้องไม่เป็นวันที่ผ่านมาแล้ว', 'error');
                        examDateInput.focus();
                        return false;
                    }
                }

                // แสดง loading state
                const submitBtn = examForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>กำลังบันทึก...';
                    submitBtn.disabled = true;

                    // เพิ่มการแจ้งเตือนให้ผู้ใช้
                    showNotification('กำลังบันทึกข้อมูลรายวิชาสอบ...', 'info');

                    // หากการส่งฟอร์มล้มเหลว ให้กู้คืนปุ่ม
                    setTimeout(() => {
                        if (submitBtn.disabled) {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            showNotification('การส่งข้อมูลใช้เวลานานเกินไป กรุณาลองใหม่อีกครั้ง', 'warning');
                        }
                    }, 15000); // 15 วินาที timeout
                }

                console.log('✅ Form validation passed, submitting...');
            });
        }

        // รีเซ็ตฟอร์ม
        const resetBtn = examForm?.querySelector('button[type="reset"]');
        if (resetBtn) {
            resetBtn.addEventListener('click', function (e) {
                e.preventDefault();

                if (confirm('คุณต้องการล้างข้อมูลทั้งหมดหรือไม่?')) {
                    examForm.reset();

                    // รีเซ็ตข้อความแสดงผล
                    if (classCountElement) {
                        classCountElement.textContent = 'เลือกระดับชั้นเพื่อดูจำนวนนักเรียน';
                    }
                    if (roomSelect) {
                        roomSelect.innerHTML = '<option value="">-- เลือกอาคารก่อน --</option>';
                        roomSelect.disabled = false;
                    }
                    if (roomInfo) {
                        roomInfo.classList.add('hidden');
                    }

                    // รีเซ็ต auto assign checkboxes
                    if (autoRoomCheckbox) {
                        autoRoomCheckbox.checked = false;
                        roomTypeHidden.value = 'manual';
                        manualRoomSection.style.opacity = '1';
                        manualRoomSection.style.pointerEvents = 'auto';
                    }

                    if (autoTeacherCheckbox) {
                        autoTeacherCheckbox.checked = false;
                        teacherTypeHidden.value = 'manual';
                        manualTeacherSection.style.opacity = '1';
                        manualTeacherSection.style.pointerEvents = 'auto';
                    }

                    // เอา error classes ออก
                    [startTimeInput, endTimeInput].forEach(input => {
                        if (input) input.classList.remove('border-red-500');
                    });

                    showNotification('ล้างข้อมูลเรียบร้อยแล้ว', 'success', 2000);
                }
            });
        }

        // ============= เพิ่มการตั้งค่าเริ่มต้น =============

        // ตั้งค่าวันที่เริ่มต้นเป็นวันพรุ่งนี้
        const examDateInput = $('#exam_date');
        if (examDateInput && !examDateInput.value) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowString = tomorrow.toISOString().split('T')[0];
            examDateInput.min = tomorrowString;
            examDateInput.value = tomorrowString;
        }

        // ตั้งค่าเวลาเริ่มต้น
        if (startTimeInput && !startTimeInput.value) {
            startTimeInput.value = '09:00';
        }
        if (endTimeInput && !endTimeInput.value) {
            endTimeInput.value = '11:00';
        }

        // ตั้งค่าปีการศึกษาปัจจุบัน
        const academicYearInput = $('input[name="academic_year"]');
        if (academicYearInput && !academicYearInput.value) {
            const currentYear = new Date().getFullYear() + 543; // แปลงเป็น พ.ศ.
            academicYearInput.value = currentYear.toString();
        }

        console.log('🎓 Add Exam Subject form initialized successfully!');
    });

    // =================== HELPER FUNCTIONS ===================

    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue || '';
    }

    function showNotification(message, type = 'info', duration = 5000) {
        // ลบ notification เก่า (ถ้ามี)
        const existingNotification = document.querySelector('.exam-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // สร้าง notification element
        const notification = document.createElement('div');
        notification.className = 'exam-notification';

        let bgColor = 'bg-blue-600';
        let icon = 'fas fa-info-circle';
        let borderColor = 'border-blue-500';

        switch (type) {
            case 'success':
                bgColor = 'bg-green-600';
                icon = 'fas fa-check-circle';
                borderColor = 'border-green-500';
                break;
            case 'error':
                bgColor = 'bg-red-600';
                icon = 'fas fa-exclamation-circle';
                borderColor = 'border-red-500';
                break;
            case 'warning':
                bgColor = 'bg-yellow-600';
                icon = 'fas fa-exclamation-triangle';
                borderColor = 'border-yellow-500';
                break;
        }

        notification.className += ` fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center space-x-3 transform translate-x-full transition-all duration-300 border ${borderColor} backdrop-blur-sm min-w-[300px] max-w-[500px]`;
        notification.innerHTML = `
        <i class="${icon} text-lg flex-shrink-0"></i>
        <span class="font-medium flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-4 text-white/80 hover:text-white transition-colors duration-200 flex-shrink-0">
            <i class="fas fa-times"></i>
        </button>
    `;

        document.body.appendChild(notification);

        // แสดง notification
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);

        // ซ่อน notification หลังจากเวลาที่กำหนด
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
    }

    // =================== PREVIEW FUNCTION ===================
    window.previewForm = function () {
        const formData = new FormData(document.getElementById('add-exam-form'));
        const data = {};

        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        // สร้างข้อความ preview
        let preview = '<div class="space-y-4 text-slate-200">';
        preview += `<h3 class="text-xl font-bold text-white mb-6 flex items-center">
        <i class="fas fa-eye mr-3 text-indigo-400"></i>
        ตัวอย่างข้อมูลรายวิชา
    </h3>`;

        // ข้อมูลพื้นฐาน
        if (data.subject_name || data.subject_code) {
            preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-purple-500/20">`;
            preview += `<h4 class="text-purple-300 font-semibold mb-2 flex items-center">
            <i class="fas fa-book mr-2"></i>ข้อมูลวิชา
        </h4>`;
            if (data.subject_name) {
                preview += `<p><strong class="text-purple-300">ชื่อวิชา:</strong> ${data.subject_name}</p>`;
            }
            if (data.subject_code) {
                preview += `<p><strong class="text-purple-300">รหัสวิชา:</strong> ${data.subject_code}</p>`;
            }
            if (data.academic_year && data.term) {
                const termText = data.term === '1' ? 'ภาคเรียนที่ 1' :
                    data.term === '2' ? 'ภาคเรียนที่ 2' :
                        data.term === '3' ? 'ภาคเรียนที่ 3' : `ภาคเรียนที่ ${data.term}`;
                preview += `<p><strong class="text-purple-300">ปีการศึกษา:</strong> ${data.academic_year} ${termText}</p>`;
            }
            preview += `</div>`;
        }

        // ข้อมูลการสอบ
        if (data.exam_date || data.start_time || data.end_time) {
            preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-blue-500/20">`;
            preview += `<h4 class="text-blue-300 font-semibold mb-2 flex items-center">
            <i class="fas fa-calendar-clock mr-2"></i>กำหนดการสอบ
        </h4>`;
            if (data.exam_date && data.start_time && data.end_time) {
                const duration = calculateDuration(data.start_time, data.end_time);
                preview += `<p><strong class="text-blue-300">วันเวลาสอบ:</strong> ${formatThaiDate(data.exam_date)} เวลา ${data.start_time} - ${data.end_time}</p>`;
                preview += `<p><strong class="text-blue-300">ระยะเวลาสอบ:</strong> ${duration}</p>`;
            }
            preview += `</div>`;
        }

        // ข้อมูลนักเรียน
        if (data.student_class) {
            const classCountEl = document.getElementById('class-count');
            const studentCount = classCountEl && classCountEl.textContent.includes('นักเรียนทั้งหมด') ?
                classCountEl.textContent.match(/\d+/)?.[0] : 'ไม่ทราบ';

            preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-emerald-500/20">`;
            preview += `<h4 class="text-emerald-300 font-semibold mb-2 flex items-center">
            <i class="fas fa-users mr-2"></i>ข้อมูลนักเรียน
        </h4>`;
            preview += `<p><strong class="text-emerald-300">ระดับชั้น:</strong> ${data.student_class}</p>`;
            if (studentCount !== 'ไม่ทราบ') {
                preview += `<p><strong class="text-emerald-300">จำนวนนักเรียน:</strong> ${studentCount} คน</p>`;
            }
            preview += `</div>`;
        }

        // ข้อมูลการจัดห้อง
        const roomAssignment = document.getElementById('auto_assign_room')?.checked ? 'อัตโนมัติ' : 'เลือกเอง';
        preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-yellow-500/20">`;
        preview += `<h4 class="text-yellow-300 font-semibold mb-2 flex items-center">
        <i class="fas fa-door-open mr-2"></i>การจัดห้องสอบ
    </h4>`;
        preview += `<p><strong class="text-yellow-300">วิธีการจัดห้อง:</strong> ${roomAssignment}</p>`;

        if (!document.getElementById('auto_assign_room')?.checked) {
            const buildingSelect = document.getElementById('building');
            const roomSelect = document.getElementById('room');

            if (buildingSelect && buildingSelect.value) {
                const selectedBuilding = buildingSelect.options[buildingSelect.selectedIndex];
                preview += `<p><strong class="text-yellow-300">อาคาร:</strong> ${selectedBuilding.text}</p>`;
            }

            if (roomSelect && roomSelect.value) {
                const selectedOption = roomSelect.options[roomSelect.selectedIndex];
                preview += `<p><strong class="text-yellow-300">ห้องสอบ:</strong> ${selectedOption.text}</p>`;
            }
        } else {
            preview += `<p class="text-yellow-200 text-sm italic">ระบบจะเลือกห้องที่เหมาะสมอัตโนมัติแบบเฉลี่ย</p>`;
        }
        preview += `</div>`;

        // ข้อมูลการจัดครู
        const teacherAssignment = document.getElementById('auto_assign_teachers')?.checked ? 'อัตโนมัติ' : 'เลือกเอง';
        preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-cyan-500/20">`;
        preview += `<h4 class="text-cyan-300 font-semibold mb-2 flex items-center">
        <i class="fas fa-chalkboard-teacher mr-2"></i>การจัดครูคุมสอบ
    </h4>`;
        preview += `<p><strong class="text-cyan-300">วิธีการจัดครู:</strong> ${teacherAssignment}</p>`;

        if (!document.getElementById('auto_assign_teachers')?.checked) {
            const primaryTeacher = document.getElementById('invigilator');
            const secondaryTeacher = document.getElementById('secondary_invigilator');

            if (primaryTeacher && primaryTeacher.value) {
                const selectedOption = primaryTeacher.options[primaryTeacher.selectedIndex];
                preview += `<p><strong class="text-cyan-300">ครูคุมสอบหลัก:</strong> ${selectedOption.text}</p>`;
            }

            if (secondaryTeacher && secondaryTeacher.value) {
                const selectedOption = secondaryTeacher.options[secondaryTeacher.selectedIndex];
                preview += `<p><strong class="text-cyan-300">ครูคุมสอบสำรอง:</strong> ${selectedOption.text}</p>`;
            }
        } else {
            preview += `<p class="text-cyan-200 text-sm italic">ระบบจะเลือกครูที่ว่างอัตโนมัติแบบเฉลี่ย</p>`;
        }
        preview += `</div>`;

        preview += '</div>';

        // แสดงใน modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
        <div class="glass-dark rounded-3xl p-8 w-full max-w-4xl border border-white/20 max-h-[80vh] overflow-y-auto">
            ${preview}
            <div class="flex justify-between items-center mt-8 pt-6 border-t border-slate-600">
                <div class="text-sm text-slate-400">
                    <i class="fas fa-info-circle mr-2"></i>
                    กรุณาตรวจสอบข้อมูลก่อนบันทึก
                </div>
                <div class="flex space-x-3">
                    <button onclick="this.closest('.fixed').remove()" 
                        class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-xl text-white transition-all duration-300">
                        <i class="fas fa-times mr-2"></i>ปิด
                    </button>
                    <button onclick="this.closest('.fixed').remove(); document.getElementById('add-exam-form').requestSubmit();" 
                        class="px-6 py-2 bg-gradient-to-r from-green-600 to-green-700 rounded-xl text-white hover:from-green-700 hover:to-green-800 transition-all duration-300 shadow-lg">
                        <i class="fas fa-save mr-2"></i>บันทึกทันที
                    </button>
                </div>
            </div>
        </div>
    `;

        document.body.appendChild(modal);

        // ปิด modal เมื่อคลิกนอกพื้นที่
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });

        // ปิด modal ด้วย ESC key
        const handleEscKey = (e) => {
            if (e.key === 'Escape' && modal.parentElement) {
                modal.remove();
                document.removeEventListener('keydown', handleEscKey);
            }
        };
        document.addEventListener('keydown', handleEscKey);
    };

    // Helper functions
    function calculateDuration(startTime, endTime) {
        if (!startTime || !endTime) return '';

        const start = new Date(`2000-01-01T${startTime}:00`);
        const end = new Date(`2000-01-01T${endTime}:00`);
        const diffMs = end - start;

        if (diffMs <= 0) return '';

        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

        if (hours === 0) return `${minutes} นาที`;
        if (minutes === 0) return `${hours} ชั่วโมง`;
        return `${hours} ชั่วโมง ${minutes} นาที`;
    }

    function formatThaiDate(dateString) {
        const date = new Date(dateString);
        const thaiMonths = [
            'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
        ];

        const thaiDays = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];

        const day = date.getDate();
        const month = thaiMonths[date.getMonth()];
        const year = date.getFullYear() + 543;
        const dayOfWeek = thaiDays[date.getDay()];

        return `วัน${dayOfWeek}ที่ ${day} ${month} ${year}`;
    }

    // เพิ่มการตรวจสอบการเชื่อมต่อ
    window.addEventListener('online', () => {
        showNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success', 2000);
    });

    window.addEventListener('offline', () => {
        showNotification('ขาดการเชื่อมต่ออินเทอร์เน็ต', 'warning', 0);
    });
</script>
{% endblock %}