{% extends 'app/base.html' %}
{% load static %}

{% block title %}‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≠‡∏ö | Exam Manager{% endblock %}

{% block page_title %}‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≠‡∏ö{% endblock %}
{% block page_subtitle %}‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£{% endblock %}

{% block current_page %}add-exam{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">
    <!-- Header Section -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div
                class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                <i class="fas fa-plus text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-slate-300 bg-clip-text text-transparent">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≠‡∏ö
                </h1>
                <p class="text-slate-400">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
        </div>
        <a href="{% url 'exam_subjects' %}"
            class="inline-flex items-center px-6 py-3 rounded-xl glass-dark hover:bg-slate-700/50 text-white transition-all duration-300 border border-slate-600">
            <i class="fas fa-arrow-left mr-3"></i>
            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </a>
    </div>

    <form method="post" action="{% url 'add_exam_subject' %}" class="space-y-8" id="add-exam-form">
        {% csrf_token %}

        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤ -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-book text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-tag mr-2 text-purple-400"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤
                    </label>
                    <input type="text" name="subject_name" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-hashtag mr-2 text-purple-400"></i>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤
                    </label>
                    <input type="text" name="subject_code" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô MATH101">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-calendar-alt mr-2 text-purple-400"></i>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                    </label>
                    <input type="text" name="academic_year" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô 2568">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-graduation-cap mr-2 text-purple-400"></i>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </label>
                    <select name="term" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                        <option value="1">‡πÄ‡∏ó‡∏≠‡∏° 1</option>
                        <option value="2">‡πÄ‡∏ó‡∏≠‡∏° 2</option>
                        <option value="3">‡πÄ‡∏ó‡∏≠‡∏° 3</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-calendar mr-2 text-purple-400"></i>‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö
                    </label>
                    <input type="date" name="exam_date" id="exam_date" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-clock mr-2 text-purple-400"></i>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö
                    </label>
                    <input type="time" name="start_time" id="start_time" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-clock mr-2 text-purple-400"></i>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏≠‡∏ö
                    </label>
                    <input type="time" name="end_time" id="end_time" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300">
                </div>
            </div>
        </div>

        <!-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-users text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-300">
                        <i class="fas fa-layer-group mr-2 text-emerald-400"></i>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
                    </label>
                    <select name="student_class" id="student_class" required
                        class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all duration-300">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
                        {% for c in classes %}
                        {% if c %}<option value="{{ c }}">{{ c }}</option>{% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="md:col-span-2">
                    <div class="flex items-center h-12 px-4 py-3 bg-slate-900/40 border border-slate-700 rounded-xl">
                        <i class="fas fa-info-circle mr-3 text-emerald-400"></i>
                        <span class="text-slate-300" id="class-count">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-door-open text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</h2>
            </div>

            <div class="space-y-6">
                <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
                <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-600">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="room_assignment_type" value="auto" id="auto_assign_room"
                            class="w-5 h-5 text-yellow-500 bg-slate-700 border-slate-600 rounded focus:ring-yellow-500">
                        <input type="hidden" name="room_assignment_type" value="manual"
                            id="room_assignment_type_hidden">
                        <div class="ml-3">
                            <span class="text-white font-medium">
                                <i class="fas fa-magic mr-2 text-yellow-400"></i>‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            </span>
                            <p class="text-slate-400 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                    </label>
                </div>

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á -->
                <div id="manual-room-section" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-building mr-2 text-yellow-400"></i>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                            </label>
                            <select id="building"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
                                {% for building in buildings %}
                                <option value="{{ building.id }}">{{ building.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-door-closed mr-2 text-yellow-400"></i>‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö
                            </label>
                            <select name="room" id="room"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô --</option>
                            </select>
                        </div>
                    </div>

                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                    <div id="room-info" class="hidden bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                            <span class="text-blue-100 font-medium">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                        </div>
                        <div id="room-details" class="text-slate-300 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö -->
        <div class="glass-dark border border-slate-700/50 rounded-2xl p-8 shadow-xl">
            <div class="flex items-center mb-6">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-chalkboard-teacher text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white">‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö</h2>
            </div>

            <div class="space-y-6">
                <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
                <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-600">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="teacher_assignment_type" value="auto" id="auto_assign_teachers"
                            class="w-5 h-5 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-500">
                        <input type="hidden" name="teacher_assignment_type" value="manual"
                            id="teacher_assignment_type_hidden">
                        <div class="ml-3">
                            <span class="text-white font-medium">
                                <i class="fas fa-magic mr-2 text-cyan-400"></i>‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            </span>
                            <p class="text-slate-400 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                    </label>
                </div>

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á -->
                <div id="manual-teacher-section" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-user-tie mr-2 text-cyan-400"></i>‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å
                            </label>
                            <select name="invigilator" id="invigilator"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all duration-300">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π --</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.user.get_full_name }} ({{ teacher.teacher_id
                                    }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-300">
                                <i class="fas fa-user-check mr-2 text-cyan-400"></i>‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á
                                <span class="text-xs text-slate-500">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
                            </label>
                            <select name="secondary_invigilator" id="secondary_invigilator"
                                class="w-full px-4 py-3 bg-slate-900/60 border border-slate-600 rounded-xl text-white focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all duration-300">
                                <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.user.get_full_name }} ({{ teacher.teacher_id
                                    }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
        <div class="flex items-center justify-between pt-8">
            <button type="reset"
                class="inline-flex items-center px-8 py-3 rounded-xl glass-dark hover:bg-slate-700/50 text-white font-medium transition-all duration-300 border border-slate-600">
                <i class="fas fa-eraser mr-3"></i>
                ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
            </button>
            <div class="flex items-center space-x-4">
                <button type="button" onclick="previewForm()"
                    class="inline-flex items-center px-8 py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-medium transition-all duration-300 shadow-lg">
                    <i class="fas fa-eye mr-3"></i>
                    ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                </button>
                <button type="submit"
                    class="inline-flex items-center px-8 py-3 rounded-xl bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold transition-all duration-300 shadow-xl">
                    <i class="fas fa-save mr-3"></i>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤
                </button>
            </div>
        </div>
    </form>
</div>
{% block extra_js %}{% endblock %}
<script>
    
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Initializing Add Exam Subject form...');

        // Helper functions for DOM selection
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

        // ============= ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Checkbox ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ =============

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ checkbox ‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const autoRoomCheckbox = $('#auto_assign_room');
        const manualRoomSection = $('#manual-room-section');
        const roomTypeHidden = $('#room_assignment_type_hidden');

        if (autoRoomCheckbox) {
            autoRoomCheckbox.addEventListener('change', function () {
                console.log('Auto room checkbox changed:', this.checked);

                if (this.checked) {
                    manualRoomSection.style.opacity = '0.5';
                    manualRoomSection.style.pointerEvents = 'none';
                    roomTypeHidden.value = 'auto';

                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                    $('#building').value = '';
                    $('#room').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô --</option>';
                    $('#room-info').classList.add('hidden');
                } else {
                    manualRoomSection.style.opacity = '1';
                    manualRoomSection.style.pointerEvents = 'auto';
                    roomTypeHidden.value = 'manual';
                }
            });
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ checkbox ‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const autoTeacherCheckbox = $('#auto_assign_teachers');
        const manualTeacherSection = $('#manual-teacher-section');
        const teacherTypeHidden = $('#teacher_assignment_type_hidden');

        if (autoTeacherCheckbox) {
            autoTeacherCheckbox.addEventListener('change', function () {
                console.log('Auto teacher checkbox changed:', this.checked);

                if (this.checked) {
                    manualTeacherSection.style.opacity = '0.5';
                    manualTeacherSection.style.pointerEvents = 'none';
                    teacherTypeHidden.value = 'auto';

                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                    $('#invigilator').value = '';
                    $('#secondary_invigilator').value = '';
                } else {
                    manualTeacherSection.style.opacity = '1';
                    manualTeacherSection.style.pointerEvents = 'auto';
                    teacherTypeHidden.value = 'manual';
                }
            });
        }

        // ============= ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô =============

        const studentClassSelect = $('#student_class');
        const classCountElement = $('#class-count');

        if (studentClassSelect && classCountElement) {
            studentClassSelect.addEventListener('change', async (e) => {
                const selectedClass = e.target.value;
                console.log('Student class changed:', selectedClass);

                if (!selectedClass) {
                    classCountElement.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                    return;
                }

                classCountElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

                try {
                    const url = `/ajax/class-students-count/?class=${encodeURIComponent(selectedClass)}`;
                    console.log('Fetching student count from:', url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                    console.log('Student count response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Student count data:', data);

                    if (data.success) {
                        classCountElement.innerHTML = `<i class="fas fa-users mr-2 text-emerald-400"></i>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="font-semibold text-emerald-400">${data.count}</span> ‡∏Ñ‡∏ô`;
                        showNotification(`‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô ${selectedClass} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${data.count} ‡∏Ñ‡∏ô`, 'success', 3000);
                    } else {
                        classCountElement.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
                        showNotification(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                    }
                } catch (err) {
                    console.error('Error loading student count:', err);
                    classCountElement.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ', 'error');
                }
            });
        }

        // ============= ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö =============

        const buildingSelect = $('#building');
        const roomSelect = $('#room');
        const roomInfo = $('#room-info');
        const roomDetails = $('#room-details');

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ -> ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á
        if (buildingSelect && roomSelect) {
            buildingSelect.addEventListener('change', async (e) => {
                const buildingId = e.target.value;
                console.log('üè¢ Building selected:', buildingId);

                // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
                if (roomInfo) roomInfo.classList.add('hidden');

                if (!buildingId) {
                    roomSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô --</option>';
                    roomSelect.disabled = false;
                    return;
                }

                // ‡πÅ‡∏™‡∏î‡∏á loading state
                roomSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á...</option>';
                roomSelect.disabled = true;

                try {
                    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö urls.py
                    const url = `/ajax/rooms/?building_id=${encodeURIComponent(buildingId)}`;
                    console.log('üìÑ Fetching rooms from:', url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                    console.log('üì° Response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Response error:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('üìä Response data:', data);

                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡πâ‡∏≠‡∏á
                    roomSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>';
                    roomSelect.disabled = false;

                    if (data.success && Array.isArray(data.rooms)) {
                        console.log(`‚úÖ Found ${data.rooms.length} rooms`);

                        if (data.rooms.length === 0) {
                            roomSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ô‡∏µ‡πâ --</option>';
                            showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
                            return;
                        }

                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô dropdown
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.id;
                            option.textContent = `‡∏´‡πâ‡∏≠‡∏á ${room.name} (‡∏à‡∏∏ ${room.capacity} ‡∏Ñ‡∏ô)`;

                            // ‡πÄ‡∏û‡∏¥‡πà‡∏° data attributes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
                            option.dataset.capacity = room.capacity;
                            option.dataset.buildingName = room.building_name || data.building_name || '';
                            option.dataset.roomName = room.name;
                            option.dataset.fullName = room.full_name || `${room.building_name} ‡∏´‡πâ‡∏≠‡∏á ${room.name}`;

                            roomSelect.appendChild(option);
                        });

                        showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.rooms.length} ‡∏´‡πâ‡∏≠‡∏á`, 'success', 2000);

                    } else {
                        console.error('‚ùå Invalid response format:', data);
                        roomSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î --</option>';

                        const errorMsg = data.error || '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                        showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMsg}`, 'error');
                    }

                } catch (error) {
                    console.error('üí• Error loading rooms:', error);
                    roomSelect.innerHTML = '<option value="">-- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î --</option>';
                    roomSelect.disabled = false;
                    showNotification(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                }
            });
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á -> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
        if (roomSelect && roomInfo && roomDetails) {
            roomSelect.addEventListener('change', function (e) {
                const selectedOption = e.target.options[e.target.selectedIndex];
                console.log('üö™ Room selected:', selectedOption.value);

                if (selectedOption.value && selectedOption.dataset.capacity) {
                    const capacity = selectedOption.dataset.capacity;
                    const buildingName = selectedOption.dataset.buildingName;
                    const roomName = selectedOption.dataset.roomName;
                    const fullName = selectedOption.dataset.fullName || selectedOption.textContent;

                    roomDetails.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <i class="fas fa-building text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
                            <span class="ml-2 text-white">${buildingName}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-users text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</span>
                            <span class="ml-2 text-white">${capacity} ‡∏Ñ‡∏ô</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-door-open text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á:</span>
                            <span class="ml-2 text-white">${roomName}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                            <span class="text-blue-300 font-medium">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°:</span>
                            <span class="ml-2 text-white">${fullName}</span>
                        </div>
                    </div>
                `;
                    roomInfo.classList.remove('hidden');
                    showNotification(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á ${fullName} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ ${capacity} ‡∏Ñ‡∏ô)`, 'info', 2000);
                } else {
                    roomInfo.classList.add('hidden');
                }
            });
        }

        // ============= ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô =============

        const primaryTeacherSelect = $('#invigilator');
        const secondaryTeacherSelect = $('#secondary_invigilator');

        if (primaryTeacherSelect && secondaryTeacherSelect) {
            primaryTeacherSelect.addEventListener('change', () => {
                const primaryId = primaryTeacherSelect.value;
                console.log('Primary teacher selected:', primaryId);

                // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î option ‡πÉ‡∏ô secondary teacher
                Array.from(secondaryTeacherSelect.options).forEach(option => {
                    if (option.value && option.value === primaryId) {
                        option.disabled = true;
                        option.style.color = '#64748b';
                    } else {
                        option.disabled = false;
                        option.style.color = '';
                    }
                });

                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                if (secondaryTeacherSelect.value === primaryId) {
                    secondaryTeacherSelect.value = '';
                    showNotification('‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π‡∏´‡∏•‡∏±‡∏Å', 'warning');
                }
            });
        }

        // ============= ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =============

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
        const startTimeInput = $('#start_time');
        const endTimeInput = $('#end_time');

        function validateTime() {
            if (startTimeInput && endTimeInput) {
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;

                if (startTime && endTime && startTime >= endTime) {
                    endTimeInput.classList.add('border-red-500');
                    startTimeInput.classList.add('border-red-500');
                    showNotification('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏≠‡∏ö', 'warning');
                    return false;
                } else {
                    endTimeInput.classList.remove('border-red-500');
                    startTimeInput.classList.remove('border-red-500');
                    return true;
                }
            }
            return true;
        }

        if (startTimeInput) {
            startTimeInput.addEventListener('change', validateTime);
        }
        if (endTimeInput) {
            endTimeInput.addEventListener('change', validateTime);
        }

        // ============= ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° =============

        const examForm = $('#add-exam-form');
        if (examForm) {
            examForm.addEventListener('submit', (e) => {
                console.log('üìù Form submission started...');

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
                if (!validateTime()) {
                    e.preventDefault();
                    endTimeInput.focus();
                    return false;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const primaryTeacher = primaryTeacherSelect?.value;
                const secondaryTeacher = secondaryTeacherSelect?.value;

                if (primaryTeacher && secondaryTeacher && primaryTeacher === secondaryTeacher) {
                    e.preventDefault();
                    showNotification('‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏•‡∏∞‡∏Ñ‡∏ô', 'error');
                    secondaryTeacherSelect.focus();
                    return false;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                const isAutoRoom = autoRoomCheckbox?.checked;
                if (!isAutoRoom && roomSelect && !roomSelect.value) {
                    e.preventDefault();
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'error');
                    roomSelect.focus();
                    return false;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                const isAutoTeacher = autoTeacherCheckbox?.checked;
                if (!isAutoTeacher && primaryTeacherSelect && !primaryTeacherSelect.value) {
                    e.preventDefault();
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'error');
                    primaryTeacherSelect.focus();
                    return false;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
                const examDateInput = $('#exam_date');
                if (examDateInput && examDateInput.value) {
                    const examDate = new Date(examDateInput.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (examDate < today) {
                        e.preventDefault();
                        showNotification('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'error');
                        examDateInput.focus();
                        return false;
                    }
                }

                // ‡πÅ‡∏™‡∏î‡∏á loading state
                const submitBtn = examForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                    submitBtn.disabled = true;

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≠‡∏ö...', 'info');

                    // ‡∏´‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏õ‡∏∏‡πà‡∏°
                    setTimeout(() => {
                        if (submitBtn.disabled) {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            showNotification('‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
                        }
                    }, 15000); // 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout
                }

                console.log('‚úÖ Form validation passed, submitting...');
            });
        }

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
        const resetBtn = examForm?.querySelector('button[type="reset"]');
        if (resetBtn) {
            resetBtn.addEventListener('click', function (e) {
                e.preventDefault();

                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    examForm.reset();

                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    if (classCountElement) {
                        classCountElement.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
                    }
                    if (roomSelect) {
                        roomSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô --</option>';
                        roomSelect.disabled = false;
                    }
                    if (roomInfo) {
                        roomInfo.classList.add('hidden');
                    }

                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï auto assign checkboxes
                    if (autoRoomCheckbox) {
                        autoRoomCheckbox.checked = false;
                        roomTypeHidden.value = 'manual';
                        manualRoomSection.style.opacity = '1';
                        manualRoomSection.style.pointerEvents = 'auto';
                    }

                    if (autoTeacherCheckbox) {
                        autoTeacherCheckbox.checked = false;
                        teacherTypeHidden.value = 'manual';
                        manualTeacherSection.style.opacity = '1';
                        manualTeacherSection.style.pointerEvents = 'auto';
                    }

                    // ‡πÄ‡∏≠‡∏≤ error classes ‡∏≠‡∏≠‡∏Å
                    [startTimeInput, endTimeInput].forEach(input => {
                        if (input) input.classList.remove('border-red-500');
                    });

                    showNotification('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success', 2000);
                }
            });
        }

        // ============= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô =============

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
        const examDateInput = $('#exam_date');
        if (examDateInput && !examDateInput.value) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowString = tomorrow.toISOString().split('T')[0];
            examDateInput.min = tomorrowString;
            examDateInput.value = tomorrowString;
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        if (startTimeInput && !startTimeInput.value) {
            startTimeInput.value = '09:00';
        }
        if (endTimeInput && !endTimeInput.value) {
            endTimeInput.value = '11:00';
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const academicYearInput = $('input[name="academic_year"]');
        if (academicYearInput && !academicYearInput.value) {
            const currentYear = new Date().getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
            academicYearInput.value = currentYear.toString();
        }

        console.log('üéì Add Exam Subject form initialized successfully!');
    });

    // =================== HELPER FUNCTIONS ===================

    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue || '';
    }

    function showNotification(message, type = 'info', duration = 5000) {
        // ‡∏•‡∏ö notification ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const existingNotification = document.querySelector('.exam-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á notification element
        const notification = document.createElement('div');
        notification.className = 'exam-notification';

        let bgColor = 'bg-blue-600';
        let icon = 'fas fa-info-circle';
        let borderColor = 'border-blue-500';

        switch (type) {
            case 'success':
                bgColor = 'bg-green-600';
                icon = 'fas fa-check-circle';
                borderColor = 'border-green-500';
                break;
            case 'error':
                bgColor = 'bg-red-600';
                icon = 'fas fa-exclamation-circle';
                borderColor = 'border-red-500';
                break;
            case 'warning':
                bgColor = 'bg-yellow-600';
                icon = 'fas fa-exclamation-triangle';
                borderColor = 'border-yellow-500';
                break;
        }

        notification.className += ` fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center space-x-3 transform translate-x-full transition-all duration-300 border ${borderColor} backdrop-blur-sm min-w-[300px] max-w-[500px]`;
        notification.innerHTML = `
        <i class="${icon} text-lg flex-shrink-0"></i>
        <span class="font-medium flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-4 text-white/80 hover:text-white transition-colors duration-200 flex-shrink-0">
            <i class="fas fa-times"></i>
        </button>
    `;

        document.body.appendChild(notification);

        // ‡πÅ‡∏™‡∏î‡∏á notification
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);

        // ‡∏ã‡πà‡∏≠‡∏ô notification ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
    }

    // =================== PREVIEW FUNCTION ===================
    window.previewForm = function () {
        const formData = new FormData(document.getElementById('add-exam-form'));
        const data = {};

        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° preview
        let preview = '<div class="space-y-4 text-slate-200">';
        preview += `<h3 class="text-xl font-bold text-white mb-6 flex items-center">
        <i class="fas fa-eye mr-3 text-indigo-400"></i>
        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
    </h3>`;

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        if (data.subject_name || data.subject_code) {
            preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-purple-500/20">`;
            preview += `<h4 class="text-purple-300 font-semibold mb-2 flex items-center">
            <i class="fas fa-book mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤
        </h4>`;
            if (data.subject_name) {
                preview += `<p><strong class="text-purple-300">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${data.subject_name}</p>`;
            }
            if (data.subject_code) {
                preview += `<p><strong class="text-purple-300">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤:</strong> ${data.subject_code}</p>`;
            }
            if (data.academic_year && data.term) {
                const termText = data.term === '1' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1' :
                    data.term === '2' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 2' :
                        data.term === '3' ? '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 3' : `‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${data.term}`;
                preview += `<p><strong class="text-purple-300">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</strong> ${data.academic_year} ${termText}</p>`;
            }
            preview += `</div>`;
        }

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö
        if (data.exam_date || data.start_time || data.end_time) {
            preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-blue-500/20">`;
            preview += `<h4 class="text-blue-300 font-semibold mb-2 flex items-center">
            <i class="fas fa-calendar-clock mr-2"></i>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö
        </h4>`;
            if (data.exam_date && data.start_time && data.end_time) {
                const duration = calculateDuration(data.start_time, data.end_time);
                preview += `<p><strong class="text-blue-300">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö:</strong> ${formatThaiDate(data.exam_date)} ‡πÄ‡∏ß‡∏•‡∏≤ ${data.start_time} - ${data.end_time}</p>`;
                preview += `<p><strong class="text-blue-300">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö:</strong> ${duration}</p>`;
            }
            preview += `</div>`;
        }

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        if (data.student_class) {
            const classCountEl = document.getElementById('class-count');
            const studentCount = classCountEl && classCountEl.textContent.includes('‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') ?
                classCountEl.textContent.match(/\d+/)?.[0] : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';

            preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-emerald-500/20">`;
            preview += `<h4 class="text-emerald-300 font-semibold mb-2 flex items-center">
            <i class="fas fa-users mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </h4>`;
            preview += `<p><strong class="text-emerald-300">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</strong> ${data.student_class}</p>`;
            if (studentCount !== '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö') {
                preview += `<p><strong class="text-emerald-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${studentCount} ‡∏Ñ‡∏ô</p>`;
            }
            preview += `</div>`;
        }

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á
        const roomAssignment = document.getElementById('auto_assign_room')?.checked ? '‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á';
        preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-yellow-500/20">`;
        preview += `<h4 class="text-yellow-300 font-semibold mb-2 flex items-center">
        <i class="fas fa-door-open mr-2"></i>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö
    </h4>`;
        preview += `<p><strong class="text-yellow-300">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á:</strong> ${roomAssignment}</p>`;

        if (!document.getElementById('auto_assign_room')?.checked) {
            const buildingSelect = document.getElementById('building');
            const roomSelect = document.getElementById('room');

            if (buildingSelect && buildingSelect.value) {
                const selectedBuilding = buildingSelect.options[buildingSelect.selectedIndex];
                preview += `<p><strong class="text-yellow-300">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ${selectedBuilding.text}</p>`;
            }

            if (roomSelect && roomSelect.value) {
                const selectedOption = roomSelect.options[roomSelect.selectedIndex];
                preview += `<p><strong class="text-yellow-300">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö:</strong> ${selectedOption.text}</p>`;
            }
        } else {
            preview += `<p class="text-yellow-200 text-sm italic">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>`;
        }
        preview += `</div>`;

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π
        const teacherAssignment = document.getElementById('auto_assign_teachers')?.checked ? '‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á';
        preview += `<div class="bg-slate-800/30 rounded-lg p-4 border border-cyan-500/20">`;
        preview += `<h4 class="text-cyan-300 font-semibold mb-2 flex items-center">
        <i class="fas fa-chalkboard-teacher mr-2"></i>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö
    </h4>`;
        preview += `<p><strong class="text-cyan-300">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π:</strong> ${teacherAssignment}</p>`;

        if (!document.getElementById('auto_assign_teachers')?.checked) {
            const primaryTeacher = document.getElementById('invigilator');
            const secondaryTeacher = document.getElementById('secondary_invigilator');

            if (primaryTeacher && primaryTeacher.value) {
                const selectedOption = primaryTeacher.options[primaryTeacher.selectedIndex];
                preview += `<p><strong class="text-cyan-300">‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å:</strong> ${selectedOption.text}</p>`;
            }

            if (secondaryTeacher && secondaryTeacher.value) {
                const selectedOption = secondaryTeacher.options[secondaryTeacher.selectedIndex];
                preview += `<p><strong class="text-cyan-300">‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á:</strong> ${selectedOption.text}</p>`;
            }
        } else {
            preview += `<p class="text-cyan-200 text-sm italic">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>`;
        }
        preview += `</div>`;

        preview += '</div>';

        // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
        <div class="glass-dark rounded-3xl p-8 w-full max-w-4xl border border-white/20 max-h-[80vh] overflow-y-auto">
            ${preview}
            <div class="flex justify-between items-center mt-8 pt-6 border-t border-slate-600">
                <div class="text-sm text-slate-400">
                    <i class="fas fa-info-circle mr-2"></i>
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </div>
                <div class="flex space-x-3">
                    <button onclick="this.closest('.fixed').remove()" 
                        class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-xl text-white transition-all duration-300">
                        <i class="fas fa-times mr-2"></i>‡∏õ‡∏¥‡∏î
                    </button>
                    <button onclick="this.closest('.fixed').remove(); document.getElementById('add-exam-form').requestSubmit();" 
                        class="px-6 py-2 bg-gradient-to-r from-green-600 to-green-700 rounded-xl text-white hover:from-green-700 hover:to-green-800 transition-all duration-300 shadow-lg">
                        <i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    </button>
                </div>
            </div>
        </div>
    `;

        document.body.appendChild(modal);

        // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });

        // ‡∏õ‡∏¥‡∏î modal ‡∏î‡πâ‡∏ß‡∏¢ ESC key
        const handleEscKey = (e) => {
            if (e.key === 'Escape' && modal.parentElement) {
                modal.remove();
                document.removeEventListener('keydown', handleEscKey);
            }
        };
        document.addEventListener('keydown', handleEscKey);
    };

    // Helper functions
    function calculateDuration(startTime, endTime) {
        if (!startTime || !endTime) return '';

        const start = new Date(`2000-01-01T${startTime}:00`);
        const end = new Date(`2000-01-01T${endTime}:00`);
        const diffMs = end - start;

        if (diffMs <= 0) return '';

        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

        if (hours === 0) return `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        if (minutes === 0) return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
        return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    }

    function formatThaiDate(dateString) {
        const date = new Date(dateString);
        const thaiMonths = [
            '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
            '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
        ];

        const thaiDays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];

        const day = date.getDate();
        const month = thaiMonths[date.getMonth()];
        const year = date.getFullYear() + 543;
        const dayOfWeek = thaiDays[date.getDay()];

        return `‡∏ß‡∏±‡∏ô${dayOfWeek}‡∏ó‡∏µ‡πà ${day} ${month} ${year}`;
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    window.addEventListener('online', () => {
        showNotification('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success', 2000);
    });

    window.addEventListener('offline', () => {
        showNotification('‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'warning', 0);
    });
</script>
{% endblock %}