{% extends 'app/base.html' %}

{% load custom_filters %}

{% block content %}
<div class="container mx-auto mt-10 max-w-6xl px-4 md:px-12">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">üéüÔ∏è ‡∏ú‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ö: {{ subject.subject_name }}</h2>

    <!-- üîπ ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
    <div class="flex justify-center space-x-6 mb-6">
        <div class="flex items-center space-x-2">
            <div class="w-6 h-6 rounded-full bg-green-500"></div>
            <span class="text-gray-700">‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
        </div>
        <div class="flex items-center space-x-2">
            <div class="w-6 h-6 rounded-full bg-yellow-500"></div>
            <span class="text-gray-700">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</span>
        </div>
        <div class="flex items-center space-x-2">
            <div class="w-6 h-6 rounded-full bg-red-500"></div>
            <span class="text-gray-700">‡∏Ç‡∏≤‡∏î‡∏™‡∏≠‡∏ö</span>
        </div>
    </div>

    <!-- ‡∏ú‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡∏Ñ‡∏£‡∏π) -->
    <h3 class="text-2xl font-semibold text-gray-700 text-center mb-4">üßë‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö</h3>
    <div class="flex justify-center mb-8">
        {% if subject.invigilator %}
        <div class="relative text-center">
            <button
                class="seat-btn w-24 h-24 rounded-xl flex items-center justify-center text-white font-bold shadow-md transition transform hover:scale-110 hover:shadow-xl {% if subject.invigilator_checkin %} bg-green-500 {% else %} bg-gray-300 {% endif %}"
                data-teacher-id="{{ subject.invigilator.id }}" data-subject-id="{{ subject.id }}"
                data-status="{% if subject.invigilator_checkin %}on_time{% else %}not_checked{% endif %}"
                id="seat-teacher" onclick="updateTeacherStatus({{ subject.invigilator.id }}, {{ subject.id }})">
                üë®‚Äçüè´ {{ subject.invigilator.user.first_name }}
            </button>
            <div class="text-sm text-gray-700 mt-2 font-medium">
                {{ subject.invigilator.user.first_name }} {{ subject.invigilator.user.last_name }}
            </div>
        </div>
        {% else %}
        <span class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏Ñ‡∏∏‡∏°‡∏™‡∏≠‡∏ö</span>
        {% endif %}
    </div>

    <!-- üîπ ‡∏ú‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) -->
    <h3 class="text-2xl font-semibold text-gray-700 text-center mb-4">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
    <div class="grid grid-cols-5 gap-6 justify-center">
        {% for student in students %}
        {% with attendance_dict|get_item:student.id as record %}
        <div class="relative text-center">
            <button
                class="seat-btn w-16 h-16 rounded-xl flex items-center justify-center text-white font-bold shadow-md transition transform hover:scale-110 hover:shadow-xl"
                data-student-id="{{ student.id }}" data-subject-id="{{ subject.id }}"
                data-status="{% if record %}{{ record.status }}{% else %}not_checked{% endif %}"
                id="seat-{{ student.id }}" onclick="updateAttendanceStatus({{ student.id }}, {{ subject.id }})">
                {{ forloop.counter }}
            </button>

            <div class="text-sm text-gray-700 mt-2 font-medium">
                {{ student.user.first_name }} {{ student.user.last_name }}
            </div>
        </div>
        {% endwith %}
        {% endfor %}
    </div>
</div>

<!-- üîπ Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
<div id="statusModal" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="bg-white p-6 rounded-lg shadow-xl relative">
        <!-- ‚ùå ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Modal -->
        <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900">
            ‚ùå
        </button>

        <h2 class="text-lg font-semibold mb-4 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2>
        <input type="hidden" id="selectedStudentId">
        <input type="hidden" id="selectedSubjectId">
        <div class="flex justify-center space-x-4">
            <button class="status-btn bg-green-500 text-white px-4 py-2 rounded-lg" data-status="on_time">‚úÖ ‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
            <button class="status-btn bg-yellow-500 text-white px-4 py-2 rounded-lg" data-status="late">‚è≥ ‡∏°‡∏≤‡∏™‡∏≤‡∏¢</button>
            <button class="status-btn bg-red-500 text-white px-4 py-2 rounded-lg" data-status="absent">üö´ ‡∏Ç‡∏≤‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>
        <button onclick="closeModal()" class="mt-4 w-full bg-gray-300 text-gray-700 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".seat-btn").forEach(btn => {
            updateSeatColor(btn);
        });

        document.querySelectorAll(".status-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                let studentId = document.getElementById("selectedStudentId").value;
                let subjectId = document.getElementById("selectedSubjectId").value;
                let newStatus = this.getAttribute("data-status");

                fetch("{% url 'manual_checkin' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        subject_id: subjectId,
                        status: newStatus
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            let seatBtn = document.getElementById("seat-" + studentId);
                            seatBtn.setAttribute("data-status", newStatus);
                            updateSeatColor(seatBtn);
                            closeModal();  // ‚úÖ ‡∏õ‡∏¥‡∏î Modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        } else {
                            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ");
                        }
                    })
                    .catch(error => console.error("Error:", error));
            });
        });

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏î ESC ‡∏õ‡∏¥‡∏î Modal
        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                closeModal();
            }
        });
    });

    function updateAttendanceStatus(studentId, subjectId) {
        console.log("üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:", studentId, " ‡∏ß‡∏¥‡∏ä‡∏≤:", subjectId);
        if (!studentId || !subjectId) {
            console.error("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            return;
        }

        document.getElementById("selectedStudentId").value = studentId;
        document.getElementById("selectedSubjectId").value = subjectId;

        let modal = document.getElementById("statusModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        console.log("‚úÖ Modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    function closeModal() {
        console.log("üöÄ ‡∏õ‡∏¥‡∏î Modal");
        let modal = document.getElementById("statusModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    function updateSeatColor(seatBtn) {
        let status = seatBtn.getAttribute("data-status");
        seatBtn.classList.remove("bg-gray-300", "bg-green-500", "bg-yellow-500", "bg-red-500");
        seatBtn.classList.add(status === "on_time" ? "bg-green-500" : status === "late" ? "bg-yellow-500" : status === "absent" ? "bg-red-500" : "bg-gray-300");
    }
</script>

{% endblock %}
