{% extends "app/base.html" %}

{% block title %}ผังที่นั่ง - {{ subject.subject_name }} | ระบบจัดการการสอบ{% endblock %}
{% block page_title %}ผังที่นั่งการสอบ - {{ subject.subject_name }}{% endblock %}
{% block page_subtitle %}แสดงการจัดที่นั่งและสถานะการเข้าสอบของนักเรียนแบบเรียลไทม์{% endblock %}
{% block current_page %}exams{% endblock %}

{% block extra_css %}
<style>
  /* ===== ใช้โทนสีเดียวกันกับ exam_attendance ===== */
  .chip{display:inline-flex;align-items:center;padding:.25rem .625rem;border-radius:9999px;font-size:.75rem;line-height:1rem;font-weight:600;border-width:1px}
  .chip-blue{border-color:rgba(59,130,246,.5);background:rgba(59,130,246,.1);color:#60a5fa}
  .chip-green{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.1);color:#22c55e}
  .chip-yellow{border-color:rgba(234,179,8,.5);background:rgba(234,179,8,.12);color:#eab308}
  .chip-red{border-color:rgba(239,68,68,.5);background:rgba(239,68,68,.1);color:#ef4444}
  .chip-slate{border-color:rgba(148,163,184,.35);background:rgba(148,163,184,.12);color:#94a3b8}
  .chip-purple{border-color:rgba(147,51,234,.5);background:rgba(147,51,234,.12);color:#a78bfa}
  .chip-orange{border-color:rgba(249,115,22,.5);background:rgba(249,115,22,.12);color:#fb923c}
  .chip-cyan{border-color:rgba(6,182,212,.5);background:rgba(6,182,212,.12);color:#06b6d4}

  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.625rem 1rem;border-radius:.75rem;font-weight:600;transition:.2s;text-decoration:none;border:none;cursor:pointer}
  .btn:hover{transform:translateY(-1px)}
  .btn-sm{padding:.375rem .75rem;font-size:.875rem}
  .btn-xs{padding:.25rem .5rem;font-size:.75rem}
  
  .btn-primary{background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff}
  .btn-secondary{background:linear-gradient(135deg,#64748b,#475569);color:#fff}
  .btn-success{background:linear-gradient(135deg,#10b981,#22c55e);color:#fff}
  .btn-warning{background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#f97316);color:#fff}
  .btn-info{background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff}

  .text-gradient{background:linear-gradient(135deg,#3b82f6,#8b5cf6,#06b6d4);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
  
  .shadow-glow-blue{box-shadow:0 0 20px rgba(59,130,246,.3)}
  .shadow-glow-green{box-shadow:0 0 20px rgba(34,197,94,.3)}
  .shadow-glow-yellow{box-shadow:0 0 20px rgba(234,179,8,.3)}
  .shadow-glow-red{box-shadow:0 0 20px rgba(239,68,68,.3)}
  .shadow-glow-purple{box-shadow:0 0 20px rgba(147,51,234,.3)}

  /* Glass effect */
  .glass{background:linear-gradient(135deg,rgba(15,23,42,.65),rgba(30,41,59,.65));border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(16px)}
  .glass-soft{background:linear-gradient(135deg,rgba(15,23,42,.45),rgba(30,41,59,.45));border:1px solid rgba(255,255,255,.12)}

  /* สถิติ Cards */
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem}
  .stat-card{position:relative;overflow:hidden}
  
  /* exam summary */
  .exam-summary{background:linear-gradient(135deg,rgba(15,23,42,.8),rgba(30,41,59,.8));border:2px solid rgba(59,130,246,.3);position:relative;overflow:hidden}
  .exam-summary::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,rgba(59,130,246,.1),rgba(139,92,246,.1));pointer-events:none}
  .exam-summary.completed{border-color:rgba(34,197,94,.5)}
  .exam-summary.completed::before{background:linear-gradient(45deg,rgba(34,197,94,.1),rgba(16,185,129,.1))}

  /* ===== ออกแบบผังที่นั่งใหม่ - จัดกึ่งกลาง ===== */
  .seating-container{max-width:1400px;margin:0 auto;padding:2rem}
  .classroom{position:relative;background:linear-gradient(135deg,rgba(15,23,42,.8),rgba(30,41,59,.8));border:2px solid rgba(59,130,246,.3);border-radius:1.5rem;padding:2rem;margin:2rem 0}
  
  /* ครูโต๊ะ - จัดให้อยู่กลาง */
  .teachers-section{display:flex;justify-content:center;align-items:center;margin-bottom:3rem;gap:3rem}
  .teacher-desk{position:relative;width:200px;height:90px;border-radius:.75rem;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;font-weight:600;box-shadow:0 4px 12px rgba(139,92,246,.3);padding:1rem}
  .teacher-desk.primary{background:linear-gradient(135deg,#8b5cf6,#6366f1)}
  .teacher-desk.secondary{background:linear-gradient(135deg,#10b981,#22c55e)}
  .teacher-desk.empty{background:linear-gradient(135deg,#64748b,#475569);opacity:0.6}

  .teacher-info{text-align:center}
  .teacher-name{font-size:.875rem;font-weight:600;margin-bottom:.25rem}
  .teacher-status{font-size:.75rem;opacity:0.9}

  /* ที่นั่งนักเรียน - รองรับหลายขนาดและจัดกึ่งกลาง */
  .seating-grid{
    display: grid;
    gap: 1.5rem;
    justify-items: center;
    align-items: center;
    justify-content: center; /* จัดกึ่งกลางในแนวนอน */
    margin: 2rem auto; /* จัดกึ่งกลางทั้งหมด */
    padding: 1rem;
    width: fit-content; /* ให้ความกว้างพอดีกับเนื้อหา */
  }
  
  /* ขนาดต่างๆ ของห้องสอบ - ทั้งหมดจัดกึ่งกลาง */
  .seating-grid.size-4x5{grid-template-columns: repeat(4, 1fr);max-width: 600px;margin: 2rem auto}
  .seating-grid.size-5x5{grid-template-columns: repeat(5, 1fr);max-width: 750px;margin: 2rem auto}
  .seating-grid.size-5x6{grid-template-columns: repeat(5, 1fr);max-width: 750px;margin: 2rem auto}
  .seating-grid.size-6x6{grid-template-columns: repeat(6, 1fr);max-width: 900px;margin: 2rem auto}
  .seating-grid.size-6x8{grid-template-columns: repeat(6, 1fr);max-width: 900px;margin: 2rem auto}
  .seating-grid.size-8x6{grid-template-columns: repeat(8, 1fr);max-width: 1200px;margin: 2rem auto}
  .seating-grid.auto{grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));max-width: 1200px;margin: 2rem auto}
  
  .seat-card{
    position: relative;
    width: 130px;
    height: 160px;
    background: linear-gradient(135deg, rgba(51,65,85,.8), rgba(71,85,105,.8));
    border-radius: 20px;
    border: 2px solid rgba(148,163,184,.3);
    cursor: pointer;
    transition: all .4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    backdrop-filter: blur(12px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0.75rem;
  }
  
  .seat-card:hover{
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(59,130,246,.3);
  }
  
  /* สถานะที่นั่ง - แก้ไขเพิ่ม not_checked และ not_started */
  .seat-card.on_time{
    background: linear-gradient(135deg,rgba(34,197,94,.85),rgba(16,185,129,.85));
    border-color: rgba(34,197,94,.6);
    color: white;
    box-shadow: 0 8px 32px rgba(34,197,94,.4);
  }
  .seat-card.late{
    background: linear-gradient(135deg,rgba(234,179,8,.85),rgba(245,158,11,.85));
    border-color: rgba(234,179,8,.6);
    color: white;
    box-shadow: 0 8px 32px rgba(234,179,8,.4);
  }
  .seat-card.absent{
    background: linear-gradient(135deg,rgba(239,68,68,.85),rgba(220,38,38,.85));
    border-color: rgba(239,68,68,.6);
    color: white;
    box-shadow: 0 8px 32px rgba(239,68,68,.4);
  }
  .seat-card.excused{
    background: linear-gradient(135deg,rgba(6,182,212,.85),rgba(14,165,233,.85));
    border-color: rgba(6,182,212,.6);
    color: white;
    box-shadow: 0 8px 32px rgba(6,182,212,.4);
  }
  .seat-card.cheating{
    background: linear-gradient(135deg,rgba(249,115,22,.85),rgba(234,88,12,.85));
    border-color: rgba(249,115,22,.6);
    color: white;
    box-shadow: 0 8px 32px rgba(249,115,22,.4);
  }
  /* เพิ่มสถานะใหม่ */
  .seat-card.not_checked{
    background: linear-gradient(135deg,rgba(148,163,184,.7),rgba(100,116,139,.7));
    border-color: rgba(148,163,184,.4);
    color: white;
    box-shadow: 0 8px 32px rgba(148,163,184,.3);
  }
  .seat-card.not_started{
    background: linear-gradient(135deg,rgba(71,85,105,.5),rgba(51,65,85,.5));
    border-color: rgba(71,85,105,.3);
    color: #94a3b8;
  }
  .seat-card.empty{
    background: rgba(51,65,85,.3);
    border-color: rgba(148,163,184,.2);
    color: #94a3b8;
    opacity: 0.5;
  }

  /* ส่วนข้อมูลในที่นั่ง */
  .seat-header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .seat-number{
    background: rgba(0,0,0,.4);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    min-width: 32px;
    text-align: center;
  }
  
  .status-indicator{
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: white;
    background: rgba(0,0,0,.3);
    border: 2px solid rgba(255,255,255,.3);
  }

  .student-avatar{
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(59,130,246,.3), rgba(139,92,246,.3));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    border: 2px solid rgba(255,255,255,.2);
  }
  
  .student-avatar i{
    font-size: 1.5rem;
    opacity: 0.8;
  }
  
  .student-info{
    text-align: center;
    flex-grow: 1;
  }
  
  .student-name{
    font-size: 0.8rem;
    font-weight: 600;
    line-height: 1.2;
    margin-bottom: 0.25rem;
    max-height: 2.4rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  
  .student-details{
    font-size: 0.65rem;
    opacity: 0.9;
    line-height: 1.3;
  }
  
  .student-id{
    margin-bottom: 0.125rem;
  }
  
  .student-class{
    font-weight: 500;
  }

  /* Animation */
  .seat-card.animate-update{
    animation: seatPulse .6s ease-out;
  }
  
  @keyframes seatPulse{
    0%{transform: scale(1)}
    50%{transform: scale(1.05)}
    100%{transform: scale(1)}
  }
  
  .animate-float{animation: float 6s ease-in-out infinite}
  @keyframes float{
    0%,100%{transform: translateY(0px)}
    50%{transform: translateY(-10px)}
  }

  /* Modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(12px);z-index:50;display:none;align-items:center;justify-content:center;padding:1rem}
  .modal-overlay.active{display:flex}
  .modal-content{max-width:500px;width:100%;max-height:90vh;overflow-y:auto}

  /* Legend - แก้ไขเพิ่มสถานะใหม่ */
  .legend{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;align-items:center;padding:1rem;background:rgba(51,65,85,.4);border-radius:.75rem;margin:1rem 0}
  .legend-item{display:flex;align-items:center;gap:.5rem;font-size:.875rem}
  .legend-dot{width:12px;height:12px;border-radius:50%}
  .legend-dot.on_time{background:#22c55e}
  .legend-dot.late{background:#eab308}
  .legend-dot.absent{background:#ef4444}
  .legend-dot.excused{background:#06b6d4}
  .legend-dot.cheating{background:#f97316}
  .legend-dot.not_checked{background:#94a3b8}
  .legend-dot.not_started{background:#475569}
  .legend-dot.empty{background:#6b7280}

  /* Loading */
  .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);z-index:9999;display:none;align-items:center;justify-content:center}
  .loading-overlay.active{display:flex}

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Layout controls */
  .layout-controls{
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .layout-btn{
    padding: 0.5rem 1rem;
    border: 2px solid rgba(59,130,246,.3);
    background: rgba(59,130,246,.1);
    color: #60a5fa;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.875rem;
  }

  .layout-btn:hover, .layout-btn.active{
    background: rgba(59,130,246,.3);
    border-color: rgba(59,130,246,.6);
    color: white;
    transform: translateY(-2px);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .seating-grid{
      gap: 1.25rem;
    }
    .seat-card{
      width: 120px;
      height: 150px;
    }
  }

  @media (max-width: 768px) {
    .seating-grid{
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)) !important;
      gap: 1rem;
      max-width: 100% !important;
    }
    .seat-card{
      width: 110px;
      height: 140px;
      padding: 0.75rem 0.5rem;
    }
    .teachers-section{
      flex-direction: column;
      gap: 1rem;
    }
    .teacher-desk{
      width: 180px;
      height: 80px;
    }
    .legend{
      flex-direction: column;
      gap: 0.5rem;
    }
    .student-avatar{
      width: 40px;
      height: 40px;
    }
    .student-avatar i{
      font-size: 1.25rem;
    }
    .layout-controls{
      flex-direction: column;
      align-items: center;
    }
  }

  @media (max-width: 480px) {
    .seating-grid{
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
      gap: 0.75rem;
    }
    .seat-card{
      width: 100px;
      height: 130px;
    }
    .student-name{
      font-size: 0.7rem;
    }
    .student-details{
      font-size: 0.6rem;
    }
  }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Header Section -->
<div class="mb-12 text-center space-y-6">
    <div class="animate-slide-up">
        <h2 class="text-4xl lg:text-5xl font-bold font-kanit mb-4">
            <span class="text-gradient">{{ subject.subject_name }}</span>
        </h2>
        <div class="flex items-center justify-center flex-wrap gap-2 text-slate-300">
            <span class="chip chip-blue"><i class="fa-solid fa-hashtag mr-1.5"></i>{{ subject.subject_code }}</span>
            <span class="chip chip-slate"><i class="fa-solid fa-calendar-day mr-1.5"></i>{{ subject.exam_date|date:"d/m/Y" }}</span>
            <span class="chip chip-purple"><i class="fa-regular fa-clock mr-1.5"></i>{{ subject.start_time|time:"H:i" }}—{{ subject.end_time|time:"H:i" }}</span>
            {% if subject.room %}
                <span class="chip chip-slate"><i class="fa-solid fa-building-columns mr-1.5"></i>{{ subject.room.building.name }} ห้อง {{ subject.room.name }}</span>
            {% endif %}
            {% if subject.students.first.student_class %}
                <span class="chip chip-green"><i class="fa-solid fa-layer-group mr-1.5"></i>{{ subject.students.first.student_class }}</span>
            {% else %}
                <span class="chip chip-yellow"><i class="fa-solid fa-layer-group mr-1.5"></i>หลายระดับชั้น</span>
            {% endif %}
        </div>
    </div>
    <div class="flex justify-center">
        <div class="w-32 h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-full"></div>
    </div>
</div>

<!-- Action Buttons และ Controls -->
<div class="flex flex-wrap gap-4 mb-8 justify-between">
  <div class="flex flex-wrap gap-3">
    <a href="{% url 'exam_attendance' subject.id %}" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-xl transition-all duration-300 transform hover:scale-105 font-semibold shadow-glow-blue">
      <i class="fa-solid fa-list-check mr-2"></i>รายละเอียดการเข้าสอบ
    </a>
    <a href="{% url 'generate_qr_code' subject.id %}" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-xl transition-all duration-300 transform hover:scale-105 font-semibold shadow-glow-purple">
      <i class="fa-solid fa-qrcode mr-2"></i>QR เช็คชื่อ
    </a>
  </div>

  <div class="flex items-center gap-2">
    <span class="text-slate-300 text-sm">อัปเดตล่าสุด:</span>
    <span id="lastUpdated" class="chip chip-blue text-xs">{{ "now"|date:"H:i" }}</span>
  </div>
</div>

<!-- สรุปผลการสอบ -->
<div class="glass exam-summary rounded-2xl p-6 mb-8 {% if exam_completed %}completed{% endif %}">
  <div class="relative z-10">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-white flex items-center gap-3">
        <i class="fas fa-chart-bar text-blue-400"></i> 
        สรุปผลการเข้าสอบ
        {% if exam_completed %}
          <span class="chip chip-green"><i class="fa-solid fa-check-circle mr-1.5"></i>สิ้นสุดการสอบ</span>
        {% else %}
          <span class="chip chip-yellow"><i class="fa-solid fa-clock mr-1.5"></i>กำลังดำเนินการ</span>
        {% endif %}
      </h3>
    </div>

    <div class="stats-grid">
      <div class="stat-card glass rounded-2xl p-6 border border-white/20 hover:border-green-500/50 transition-all duration-300 animate-float">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-400 text-sm mb-1">เข้าสอบตรงเวลา</p>
            <p class="text-3xl font-bold text-green-400" data-stat="on_time">{{ stats.on_time }}</p>
            <p class="text-xs text-slate-500 mt-1">{{ stats.on_time_percentage|floatformat:1 }}% ของทั้งหมด</p>
          </div>
          <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-user-check text-green-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="stat-card glass rounded-2xl p-6 border border-white/20 hover:border-yellow-500/50 transition-all duration-300 animate-float" style="animation-delay: 0.2s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-400 text-sm mb-1">เข้าสอบสาย</p>
            <p class="text-3xl font-bold text-yellow-400" data-stat="late">{{ stats.late }}</p>
            <p class="text-xs text-slate-500 mt-1">{{ stats.late_percentage|floatformat:1 }}% ของทั้งหมด</p>
          </div>
          <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-clock text-yellow-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="stat-card glass rounded-2xl p-6 border border-white/20 hover:border-red-500/50 transition-all duration-300 animate-float" style="animation-delay: 0.4s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-400 text-sm mb-1">ขาดสอบ</p>
            <p class="text-3xl font-bold text-red-400" data-stat="absent">{{ stats.absent }}</p>
            <p class="text-xs text-slate-500 mt-1">{{ stats.absent_percentage|floatformat:1 }}% ของทั้งหมด</p>
          </div>
          <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-user-xmark text-red-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="stat-card glass rounded-2xl p-6 border border-white/20 hover:border-slate-500/50 transition-all duration-300 animate-float" style="animation-delay: 0.6s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-400 text-sm mb-1">ยังไม่เช็คชื่อ</p>
            <p class="text-3xl font-bold text-slate-400" data-stat="not_checked">{{ stats.not_checked }}</p>
            <p class="text-xs text-slate-500 mt-1">{{ stats.not_checked_percentage|floatformat:1 }}% ของทั้งหมด</p>
          </div>
          <div class="w-12 h-12 bg-slate-500/20 rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-hourglass-half text-slate-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="stat-card glass rounded-2xl p-6 border border-white/20 hover:border-cyan-500/50 transition-all duration-300 animate-float" style="animation-delay: 0.8s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-400 text-sm mb-1">ลาป่วย</p>
            <p class="text-3xl font-bold text-cyan-400" data-stat="excused">{{ stats.excused }}</p>
            <p class="text-xs text-slate-500 mt-1">{{ stats.excused_percentage|floatformat:1 }}% ของทั้งหมด</p>
          </div>
          <div class="w-12 h-12 bg-cyan-500/20 rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-notes-medical text-cyan-400 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="stat-card glass rounded-2xl p-6 border border-white/20 hover:border-orange-500/50 transition-all duration-300 animate-float" style="animation-delay: 1.0s;">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-400 text-sm mb-1">ทุจริต</p>
            <p class="text-3xl font-bold text-orange-400" data-stat="cheating">{{ stats.cheating }}</p>
            <p class="text-xs text-slate-500 mt-1">{{ stats.cheating_percentage|floatformat:1 }}% ของทั้งหมด</p>
          </div>
          <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-exclamation-triangle text-orange-400 text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Legend - แก้ไขเพิ่มสถานะใหม่ -->
<div class="legend">
  <div class="legend-item">
    <div class="legend-dot on_time"></div>
    <span class="text-slate-300">เข้าสอบตรงเวลา</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot late"></div>
    <span class="text-slate-300">เข้าสอบสาย</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot absent"></div>
    <span class="text-slate-300">ขาดสอบ</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot excused"></div>
    <span class="text-slate-300">ลาป่วย</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot cheating"></div>
    <span class="text-slate-300">ทุจริต</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot not_checked"></div>
    <span class="text-slate-300">ยังไม่เช็คชื่อ</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot not_started"></div>
    <span class="text-slate-300">ยังไม่เริ่มสอบ</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot empty"></div>
    <span class="text-slate-300">ที่นั่งว่าง</span>
  </div>
</div>

<!-- Layout Controls -->
<div class="glass rounded-2xl border border-white/20 mb-6">
  <div class="p-4 border-b border-white/10">
    <h3 class="text-lg font-bold text-white flex items-center gap-3">
      <i class="fas fa-th text-blue-400"></i> เลือกรูปแบบการจัดที่นั่ง
    </h3>
  </div>
  
  <div class="p-4">
    <div class="layout-controls">
      <button class="layout-btn" onclick="changeLayout('4x5')" data-layout="4x5">
        <i class="fa-solid fa-grip mr-2"></i>4×5 (20 ที่นั่ง)
      </button>
      <button class="layout-btn" onclick="changeLayout('5x5')" data-layout="5x5">
        <i class="fa-solid fa-grip mr-2"></i>5×5 (25 ที่นั่ง)
      </button>
      <button class="layout-btn" onclick="changeLayout('5x6')" data-layout="5x6">
        <i class="fa-solid fa-grip mr-2"></i>5×6 (30 ที่นั่ง)
      </button>
      <button class="layout-btn" onclick="changeLayout('6x6')" data-layout="6x6">
        <i class="fa-solid fa-grip mr-2"></i>6×6 (36 ที่นั่ง)
      </button>
      <button class="layout-btn" onclick="changeLayout('6x8')" data-layout="6x8">
        <i class="fa-solid fa-grip mr-2"></i>6×8 (48 ที่นั่ง)
      </button>
      <button class="layout-btn" onclick="changeLayout('8x6')" data-layout="8x6">
        <i class="fa-solid fa-grip mr-2"></i>8×6 (48 ที่นั่ง)
      </button>
      <button class="layout-btn active" onclick="changeLayout('auto')" data-layout="auto">
        <i class="fa-solid fa-expand mr-2"></i>อัตโนมัติ
      </button>
    </div>
  </div>
</div>

<!-- Classroom Layout ใหม่ - จัดกึ่งกลางทั้งหมด -->
<div class="classroom">
  <!-- Teachers Section - อยู่กลาง -->
  <div class="teachers-section">
    <!-- ครูหลัก -->
    <div class="teacher-desk primary">
      <div class="teacher-info">
        <div class="teacher-name">
          <i class="fa-solid fa-chalkboard-user mr-1"></i>
          ครูหลัก
        </div>
        {% if subject.invigilator %}
          <div class="teacher-status">{{ subject.invigilator.user.get_full_name }}</div>
          {% if subject.invigilator_checkin %}
            <div class="text-xs mt-1 text-green-200">
              <i class="fa-solid fa-check mr-1"></i>เข้าหน้าที่แล้ว
            </div>
          {% else %}
            <div class="text-xs mt-1 text-red-200">
              <i class="fa-solid fa-clock mr-1"></i>ยังไม่เข้าหน้าที่
            </div>
          {% endif %}
        {% else %}
          <div class="teacher-status text-slate-300">ยังไม่ระบุครู</div>
        {% endif %}
      </div>
    </div>

    <!-- ครูสำรอง -->
    <div class="teacher-desk {% if subject.secondary_invigilator %}secondary{% else %}empty{% endif %}">
      <div class="teacher-info">
        <div class="teacher-name">
          <i class="fa-solid fa-user-tie mr-1"></i>
          ครูสำรอง
        </div>
        {% if subject.secondary_invigilator %}
          <div class="teacher-status">{{ subject.secondary_invigilator.user.get_full_name }}</div>
          {% if subject.secondary_invigilator_checkin %}
            <div class="text-xs mt-1 text-green-200">
              <i class="fa-solid fa-check mr-1"></i>เข้าหน้าที่แล้ว
            </div>
          {% else %}
            <div class="text-xs mt-1 text-red-200">
              <i class="fa-solid fa-clock mr-1"></i>ยังไม่เข้าหน้าที่
            </div>
          {% endif %}
        {% else %}
          <div class="teacher-status text-slate-400">ยังไม่ระบุครู</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ผังที่นั่งใหม่ - จัดกึ่งกลางและเรียงตามเลขที่ -->
  <div class="seating-grid auto" id="seatingChart">
    {% if seating_chart %}
      {% for row in seating_chart %}
        {% for seat in row %}
          {% if seat %}
            {% with student=seat.student attendance=seat.attendance status=seat.status %}
              <div class="seat-card {{ status|default:'not_checked' }}" 
                   data-student-id="{{ student.id }}"
                   data-seat-number="{{ seat.seat_number }}"
                   onclick="showStudentDetail({{ student.id }}, '{{ student.user.get_full_name|escapejs }}', '{{ student.student_id }}', '{{ status|default:'not_checked' }}', '{% if attendance %}{{ attendance.checkin_time|time:'H:i' }}{% endif %}', '{{ student.student_number }}', '{{ student.student_class }}')">
                
                <!-- Header ที่นั่ง -->
                <div class="seat-header">
                  <div class="seat-number">{{ seat.seat_number }}</div>
                  <div class="status-indicator">
                    {% if status == 'on_time' %}
                      <i class="fa-solid fa-check"></i>
                    {% elif status == 'late' %}
                      <i class="fa-solid fa-clock"></i>
                    {% elif status == 'excused' %}
                      <i class="fa-solid fa-notes-medical"></i>
                    {% elif status == 'cheating' %}
                      <i class="fa-solid fa-exclamation-triangle"></i>
                    {% elif status == 'absent' %}
                      <i class="fa-solid fa-xmark"></i>
                    {% elif status == 'not_checked' %}
                      <i class="fa-solid fa-hourglass-half"></i>
                    {% elif status == 'not_started' %}
                      <i class="fa-solid fa-pause"></i>
                    {% else %}
                      <i class="fa-solid fa-question"></i>
                    {% endif %}
                  </div>
                </div>

                <!-- Avatar นักเรียน -->
                <div class="student-avatar">
                  <i class="fas fa-user-graduate"></i>
                </div>

                <!-- ข้อมูลนักเรียน -->
                <div class="student-info">
                  <div class="student-name">{{ student.user.get_full_name }}</div>
                  <div class="student-details">
                    <div class="student-id">{{ student.student_id }}</div>
                    <div class="student-class">{{ student.student_class }} เลขที่ {{ student.student_number }}</div>
                  </div>
                </div>
              </div>
            {% endwith %}
          {% else %}
            <!-- ที่นั่งว่าง -->
            <div class="seat-card empty">
              <div class="seat-header">
                <div class="seat-number">-</div>
                <div class="status-indicator">
                  <i class="fa-solid fa-minus"></i>
                </div>
              </div>
              <div class="student-avatar">
                <i class="fas fa-chair"></i>
              </div>
              <div class="student-info">
                <div class="student-name">ที่นั่งว่าง</div>
                <div class="student-details">
                  <div class="student-id">-</div>
                  <div class="student-class">-</div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% else %}
      <div class="col-span-full text-center text-slate-400 py-8">
        <i class="fa-solid fa-chair text-4xl mb-4 opacity-50"></i>
        <p>ไม่มีข้อมูลที่นั่ง</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Student Detail Modal -->
<div id="studentModal" class="modal-overlay">
  <div class="modal-content glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-white">รายละเอียดนักเรียน</h3>
      <button onclick="closeStudentModal()" class="text-slate-400 hover:text-white transition-colors">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>

    <div id="studentInfo" class="space-y-4">
      <!-- Student info will be populated by JavaScript -->
    </div>

    <div class="flex gap-3 mt-6">
      <button onclick="closeStudentModal()" class="btn btn-secondary flex-1">
        <i class="fa-solid fa-xmark"></i> ปิด
      </button>
      {% if can_edit %}
        <button onclick="editStudentStatus()" class="btn btn-primary flex-1">
          <i class="fa-solid fa-edit"></i> แก้ไขสถานะ
        </button>
      {% endif %}
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="glass rounded-2xl p-6 text-center border border-white/20">
    <div class="loading-spinner mb-4"></div>
    <p class="text-white font-medium">กำลังโหลด...</p>
  </div>
</div>

<!-- แจ้งเตือน -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
  const CAN_EDIT = {{ can_edit|yesno:"true,false" }};
  let refreshInterval;
  let examCompleted = {{ exam_completed|yesno:"true,false" }};
  let currentLayout = 'auto';

  // เริ่มต้น
  document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
    updateLastUpdatedTime();
    
    // เพิ่ม animation delay สำหรับที่นั่งแต่ละตัว
    const seats = document.querySelectorAll('.seat-card');
    seats.forEach((seat, index) => {
      seat.style.animationDelay = `${index * 0.05}s`;
      seat.classList.add('animate-float');
      
      // เพิ่ม hover effect
      seat.addEventListener('mouseenter', function() {
        this.style.filter = `drop-shadow(0 0 20px rgba(59,130,246,0.4))`;
      });
      
      seat.addEventListener('mouseleave', function() {
        this.style.filter = '';
      });
    });
    
    // รีเฟรชข้อมูลทุก 30 วินาที
    if (!examCompleted) {
      setInterval(refreshSeatingData, 30000);
    }
  });

  // เปลี่ยนรูปแบบการจัดที่นั่ง
  function changeLayout(layout) {
    const seatingGrid = document.getElementById('seatingChart');
    const layoutButtons = document.querySelectorAll('.layout-btn');
    
    // ลบ class เก่า
    seatingGrid.classList.remove('auto', 'size-4x5', 'size-5x5', 'size-5x6', 'size-6x6', 'size-6x8', 'size-8x6');
    
    // เพิ่ม class ใหม่
    if (layout === 'auto') {
      seatingGrid.classList.add('auto');
    } else {
      seatingGrid.classList.add(`size-${layout}`);
    }
    
    // อัปเดต active button
    layoutButtons.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-layout="${layout}"]`).classList.add('active');
    
    currentLayout = layout;
    
    // Animate การเปลี่ยนแปลง
    const seats = document.querySelectorAll('.seat-card');
    seats.forEach((seat, index) => {
      seat.style.animationDelay = `${index * 0.02}s`;
      seat.classList.add('animate-update');
      
      setTimeout(() => {
        seat.classList.remove('animate-update');
      }, 600);
    });
    
    showNotification(`เปลี่ยนเป็นรูปแบบ ${layout === 'auto' ? 'อัตโนมัติ' : layout.replace('x', '×')}`, 'success');
  }

  // แสดงรายละเอียดนักเรียน - แก้ไขให้รองรับสถานะใหม่
  function showStudentDetail(studentId, fullName, studentIdCode, status, checkinTime, studentNumber, studentClass) {
    const statusMap = {
      'on_time': { text: 'เข้าสอบตรงเวลา', class: 'chip-green', icon: 'fa-check' },
      'late': { text: 'เข้าสอบสาย', class: 'chip-yellow', icon: 'fa-clock' },
      'absent': { text: 'ขาดสอบ', class: 'chip-red', icon: 'fa-xmark' },
      'excused': { text: 'ลาป่วย', class: 'chip-cyan', icon: 'fa-notes-medical' },
      'cheating': { text: 'ทุจริต', class: 'chip-orange', icon: 'fa-exclamation-triangle' },
      'not_checked': { text: 'ยังไม่เช็คชื่อ', class: 'chip-slate', icon: 'fa-hourglass-half' },
      'not_started': { text: 'ยังไม่เริ่มสอบ', class: 'chip-slate', icon: 'fa-pause' }
    };

    const statusInfo = statusMap[status] || statusMap['not_checked'];
    
    const studentInfo = document.getElementById('studentInfo');
    studentInfo.innerHTML = `
      <div class="glass-soft rounded-xl p-4">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center">
            <i class="fas fa-user-graduate text-blue-400 text-2xl"></i>
          </div>
          <div>
            <h4 class="text-xl font-semibold text-white">${fullName}</h4>
            <p class="text-slate-300">รหัสนักเรียน: ${studentIdCode}</p>
            <p class="text-slate-300">ชั้น ${studentClass} เลขที่ ${studentNumber}</p>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-slate-400 text-sm">ที่นั่ง</label>
            <p class="text-white font-medium">ที่ ${document.querySelector(`[data-student-id="${studentId}"]`)?.dataset.seatNumber || 'ไม่ระบุ'}</p>
          </div>
          <div>
            <label class="text-slate-400 text-sm">ห้องสอบ</label>
            <p class="text-white font-medium">{{ subject.room.building.name|default:"ไม่ระบุ" }} ห้อง {{ subject.room.name|default:"ไม่ระบุ" }}</p>
          </div>
          <div>
            <label class="text-slate-400 text-sm">สถานะ</label>
            <div class="mt-1">
              <span class="chip ${statusInfo.class}">
                <i class="fa-solid ${statusInfo.icon}"></i> ${statusInfo.text}
              </span>
            </div>
          </div>
          <div>
            <label class="text-slate-400 text-sm">เวลาเข้าสอบ</label>
            <p class="text-white font-medium">${checkinTime || 'ยังไม่เข้าสอบ'}</p>
          </div>
        </div>
      </div>
    `;

    // เก็บข้อมูลสำหรับการแก้ไข
    studentInfo.dataset.studentId = studentId;
    studentInfo.dataset.currentStatus = status;

    document.getElementById('studentModal').classList.add('active');
  }

  // ปิด modal
  function closeStudentModal() {
    document.getElementById('studentModal').classList.remove('active');
  }

  // แก้ไขสถานะนักเรียน
  async function editStudentStatus() {
    // ตรวจสอบสิทธิ์จากตัวแปร CAN_EDIT
    if (typeof CAN_EDIT === 'undefined' || !CAN_EDIT) {
      showNotification('คุณไม่มีสิทธิ์แก้ไขข้อมูล', 'error');
      return;
    }

    const studentInfo = document.getElementById('studentInfo');
    const studentId = studentInfo.dataset.studentId;
    const currentStatus = studentInfo.dataset.currentStatus;

    const newStatus = prompt('เลือกสถานะใหม่:\n\n1. เข้าสอบตรงเวลา\n2. เข้าสอบสาย\n3. ขาดสอบ\n4. ลาป่วย\n5. ทุจริต\n\nกรอกหมายเลข 1-5:');
    
    const statusMapping = {
      '1': 'on_time',
      '2': 'late', 
      '3': 'absent',
      '4': 'excused',
      '5': 'cheating'
    };

    const selectedStatus = statusMapping[newStatus];
    
    if (!selectedStatus) {
      showNotification('กรุณาเลือกสถานะที่ถูกต้อง', 'error');
      return;
    }

    try {
      showLoading('กำลังอัปเดตสถานะ...');
      
      const response = await fetch("{% url 'manual_checkin_student' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          student_id: studentId,
          subject_id: {{ subject.id }},
          status: selectedStatus
        })
      });

      const data = await response.json();
      
      if (data.status === 'success') {
        updateSeatDisplay(studentId, selectedStatus);
        showNotification('อัปเดตสถานะสำเร็จ', 'success');
        closeStudentModal();
        
        // รีเฟรชข้อมูลหลังอัปเดต
        setTimeout(refreshSeatingData, 1000);
      } else {
        showNotification(data.message || 'เกิดข้อผิดพลาด', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('เชื่อมต่อไม่ได้ กรุณาลองใหม่อีกครั้ง', 'error');
    } finally {
      hideLoading();
    }
  }

  // อัปเดตการแสดงผลที่นั่ง - แก้ไขให้รองรับสถานะใหม่
  function updateSeatDisplay(studentId, status) {
    const seat = document.querySelector(`[data-student-id="${studentId}"]`);
    if (!seat) return;

    // ลบคลาสสถานะเก่า
    seat.classList.remove('on_time', 'late', 'absent', 'excused', 'cheating', 'not_checked', 'not_started');
    
    // เพิ่มคลาสสถานะใหม่
    seat.classList.add(status);
    seat.classList.add('animate-update');

    // อัปเดตไอคอนสถานะ
    const statusIcon = seat.querySelector('.status-indicator');
    if (statusIcon) {
      const iconMap = {
        'on_time': 'fa-check',
        'late': 'fa-clock',
        'absent': 'fa-xmark',
        'excused': 'fa-notes-medical',
        'cheating': 'fa-exclamation-triangle',
        'not_checked': 'fa-hourglass-half',
        'not_started': 'fa-pause'
      };
      
      statusIcon.innerHTML = `<i class="fa-solid ${iconMap[status] || 'fa-question'}"></i>`;
    }

    // ลบ animation หลังเสร็จ
    setTimeout(() => {
      seat.classList.remove('animate-update');
    }, 600);
  }

  // รีเฟรชข้อมูลผังที่นั่ง
  async function refreshSeatingData() {
    try {
      showLoading('กำลังอัปเดตข้อมูล...');
      
      const response = await fetch(`{% url 'exam_seating_data' subject.id %}`);
      const data = await response.json();
      
      if (data.success) {
        // อัปเดตสถานะของแต่ละที่นั่ง
        Object.entries(data.attendance).forEach(([studentId, attendance]) => {
          updateSeatDisplay(studentId, attendance.status);
        });
        
        // อัปเดตสถิติ
        updateStats(data.stats);
        updateLastUpdatedTime();
        
        showNotification('อัปเดตข้อมูลล่าสุดแล้ว', 'success', 2000);
      } else {
        showNotification('ไม่สามารถอัปเดตข้อมูลได้', 'error');
      }
    } catch (error) {
      console.error('Error refreshing data:', error);
      showNotification('เกิดข้อผิดพลาดในการรีเฟรช', 'error');
    } finally {
      hideLoading();
    }
  }

  // อัปเดตสถิติ
  function updateStats(stats) {
    const elements = {
      'on_time': stats.on_time || 0,
      'late': stats.late || 0,
      'absent': stats.absent || 0,
      'excused': stats.excused || 0,
      'cheating': stats.cheating || 0,
      'not_checked': stats.not_checked || 0
    };

    Object.entries(elements).forEach(([key, value]) => {
      const element = document.querySelector(`[data-stat="${key}"]`);
      if (element) {
        animateNumber(element, value);
      }
    });
  }

  // แอนิเมชั่นตัวเลข
  function animateNumber(element, targetValue) {
    const currentValue = parseInt(element.textContent) || 0;
    const difference = targetValue - currentValue;
    const steps = 10;
    const stepValue = difference / steps;
    let current = currentValue;
    
    const interval = setInterval(() => {
      current += stepValue;
      if ((stepValue > 0 && current >= targetValue) || (stepValue < 0 && current <= targetValue)) {
        element.textContent = targetValue;
        clearInterval(interval);
      } else {
        element.textContent = Math.round(current);
      }
    }, 50);
  }

  // อัปเดตเวลา
  function updateLastUpdatedTime() {
    const timeElement = document.getElementById('lastUpdated');
    if (timeElement) {
      const now = new Date();
      timeElement.textContent = now.toLocaleTimeString('th-TH', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
  }

  // เริ่ม auto refresh
  function startAutoRefresh() {
    // อัปเดตเวลาทุกวินาที
    setInterval(updateLastUpdatedTime, 1000);
  }

  // ส่งออกรายงาน
  function exportAttendanceReport() {
    const url = `{% url 'export_attendance_report' subject.id %}`;
    window.open(url, '_blank');
  }

  // แจ้งเตือน
  function showNotification(message, type = 'info', duration = 3000) {
    const colors = {
      success: 'bg-green-500/20 border-green-500/50 text-green-400',
      error: 'bg-red-500/20 border-red-500/50 text-red-400', 
      warning: 'bg-yellow-500/20 border-yellow-500/50 text-yellow-400',
      info: 'bg-blue-500/20 border-blue-500/50 text-blue-400'
    };
    
    const icons = {
      success: 'fa-check-circle',
      error: 'fa-exclamation-circle',
      warning: 'fa-exclamation-triangle',
      info: 'fa-info-circle'
    };

    const notification = document.createElement('div');
    notification.className = `${colors[type]} border rounded-xl p-4 backdrop-blur-sm transform translate-x-full transition-transform duration-300`;
    notification.innerHTML = `
      <div class="flex items-center gap-3">
        <i class="fas ${icons[type]}"></i>
        <span class="font-medium">${message}</span>
      </div>
    `;

    const container = document.getElementById('notificationContainer');
    if (container) {
      container.appendChild(notification);
      
      setTimeout(() => notification.style.transform = 'translateX(0)', 50);
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, duration);
    }
  }

  function showLoading(message = 'กำลังโหลด...') {
    const loader = document.getElementById('loadingOverlay');
    if (loader) {
      loader.querySelector('p').textContent = message;
      loader.classList.add('active');
    }
  }

  function hideLoading() {
    const loader = document.getElementById('loadingOverlay');
    if (loader) {
      loader.classList.remove('active');
    }
  }

  // ปิด modal เมื่อคลิกข้างนอก
  document.getElementById('studentModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeStudentModal();
    }
  });

  // ESC key ปิด modal
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeStudentModal();
    }
  });

  // ปิด auto refresh เมื่อออกจากหน้า
  window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
  });

  // ปรับ responsive เมื่อขนาดหน้าจอเปลี่ยน
  window.addEventListener('resize', function() {
    const seatingChart = document.getElementById('seatingChart');
    if (window.innerWidth <= 768) {
      // Force responsive layout on mobile
      seatingChart.classList.remove('size-4x5', 'size-5x5', 'size-5x6', 'size-6x6', 'size-6x8', 'size-8x6');
      seatingChart.classList.add('auto');
    }
  });
</script>
{% endblock %}