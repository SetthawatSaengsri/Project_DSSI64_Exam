{% extends "app/base.html" %}

{% block title %}QR Code สำหรับเข้าสอบ - {{ subject.subject_name }} - ระบบจัดการการสอบ{% endblock %}

{% block extra_css %}
<style>
    .text-gradient {
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .shadow-card {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .animate-fade-in {
        animation: fadeIn 0.8s ease-out forwards;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
    
    .qr-container {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        border: 2px solid rgba(59, 130, 246, 0.2);
        backdrop-filter: blur(10px);
    }
    
    .info-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .info-card:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }
    
    .qr-actions {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }
    
    .teacher-info {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
        border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .class-info {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .teacher-badge {
        background: rgba(139, 92, 246, 0.2);
        color: #a855f7;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .class-badge {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 16px;
        min-width: 150px;
        position: relative;
        overflow: hidden;
        user-select: none;
    }
    
    .btn-print {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
    }
    
    .btn-print:hover {
        background: linear-gradient(135deg, #047857, #065f46);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .btn-share {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        color: white;
        box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
    }
    
    .btn-share:hover {
        background: linear-gradient(135deg, #6d28d9, #5b21b6);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .btn-attendance {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }
    
    .btn-attendance:hover {
        background: linear-gradient(135deg, #b91c1c, #991b1b);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .copy-btn {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .copy-btn:hover {
        background: rgba(59, 130, 246, 0.3) !important;
        transform: scale(1.05);
    }
    
    .copy-success {
        background: rgba(34, 197, 94, 0.3) !important;
        color: #22c55e !important;
    }

    .status-badge {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    /* Mobile optimization */
    @media (max-width: 768px) {
        .grid-cols-3 { grid-template-columns: 1fr; }
        .text-4xl { font-size: 1.875rem; }
        .text-2xl { font-size: 1.25rem; }
        .p-8 { padding: 1.5rem; }
        .space-y-8 > * + * { margin-top: 1.5rem; }
        .action-btn {
            min-width: 120px;
            padding: 10px 16px;
            font-size: 14px;
        }
        .qr-container img {
            width: 250px !important;
            height: 250px !important;
        }
    }
    
    @media print {
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body { 
            background: white !important;
            color: black !important;
            margin: 0 !important;
            padding: 20px !important;
        }
        
        /* ซ่อนปุ่มต่างๆ */
        .no-print { 
            display: none !important; 
        }
        
        .print-only { 
            display: block !important; 
        }
        
        /* Container */
        .max-w-6xl {
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .space-y-8 {
            display: block !important;
        }
        
        .space-y-8 > * {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* ซ่อนส่วน Header ที่ไม่ต้องการ */
        .text-center.mb-8 .inline-flex {
            display: none !important;
        }
        
        .text-center.mb-8 h1 {
            font-size: 24px !important;
            margin-bottom: 10px !important;
            color: black !important;
        }
        
        .text-center.mb-8 p {
            display: none !important;
        }
        
        .status-badge {
            display: none !important;
        }
        
        /* QR Code Container */
        .qr-container { 
            display: block !important;
            visibility: visible !important;
            background: white !important; 
            border: 3px solid #000 !important; 
            page-break-inside: avoid !important;
            margin-bottom: 30px !important;
            padding: 20px !important;
            text-align: center !important;
        }
        
        .qr-container > div {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
        }
        
        .qr-container .bg-white {
            display: block !important;
            visibility: visible !important;
            background: white !important;
            border: 2px solid #000 !important;
            padding: 20px !important;
        }
        
        .qr-container img {
            display: block !important;
            visibility: visible !important;
            width: 300px !important;
            height: 300px !important;
            border: 2px solid #000 !important;
        }
        
        /* แสดงเฉพาะ URL ไม่ต้องแสดงปุ่ม copy */
        .qr-container .text-center {
            display: block !important;
        }
        
        .qr-container .bg-slate-800\/50 {
            display: block !important;
            background: #f5f5f5 !important;
            border: 1px solid #ddd !important;
            padding: 10px !important;
        }
        
        .qr-container button {
            display: none !important;
        }
        
        /* Grid - แสดงเฉพาะการ์ดแรก (รายละเอียดการสอบ) */
        .grid.lg\:grid-cols-3 {
            display: block !important;
        }
        
        /* แสดงเฉพาะการ์ดแรก - รายละเอียดการสอบ */
        .grid.lg\:grid-cols-3 > .info-card:first-child {
            display: block !important;
            visibility: visible !important;
            background: white !important; 
            border: 2px solid #333 !important;
            page-break-inside: avoid !important;
            margin-bottom: 20px !important;
            padding: 20px !important;
        }
        
        /* ซ่อนการ์ดที่ 2 และ 3 (ครูผู้คุมสอบและข้อมูลระดับชั้น) */
        .grid.lg\:grid-cols-3 > .info-card:nth-child(2),
        .grid.lg\:grid-cols-3 > .info-card:nth-child(3) {
            display: none !important;
        }
        
        /* ซ่อนส่วนคำแนะนำการใช้งาน */
        .grid.lg\:grid-cols-3 ~ .info-card {
            display: none !important;
        }
        
        /* Information Cards */
        .info-card { 
            display: block !important;
            visibility: visible !important;
        }
        
        .info-card > * {
            display: block !important;
            visibility: visible !important;
        }
        
        /* Text and Headers */
        h1, h2, h3, h4, h5, h6, p, span, div {
            color: black !important;
        }
        
        .text-white, .text-slate-300, .text-slate-400, .text-slate-500,
        .text-blue-400, .text-purple-400, .text-green-400, .text-orange-400, 
        .text-yellow-400, .text-red-400, .text-5xl, .text-2xl, .text-xl, .text-lg {
            color: black !important;
        }
        
        .text-gradient {
            color: black !important;
            background: none !important;
            -webkit-text-fill-color: black !important;
        }
        
        /* Flex items */
        .flex, .inline-flex {
            display: flex !important;
            visibility: visible !important;
        }
        
        .items-center {
            align-items: center !important;
        }
        
        .justify-between {
            justify-content: space-between !important;
        }
        
        .space-y-4 > * + * {
            margin-top: 12px !important;
        }
        
        /* Icons */
        .fas, .far, i {
            display: inline-block !important;
            visibility: visible !important;
            color: #333 !important;
        }
        
        /* Borders */
        .border-b {
            border-bottom-width: 1px !important;
        }
        
        .border-slate-700 {
            border-color: #ccc !important;
        }
        
        .rounded-xl, .rounded-2xl, .rounded-3xl {
            border-radius: 8px !important;
        }
        
        /* Background colors */
        .bg-blue-500\/20, .bg-blue-500\/10 {
            background: #f9f9f9 !important;
        }
        
        /* Remove animations */
        *, *::before, *::after {
            animation: none !important;
            transition: none !important;
            transform: none !important;
        }
        
        /* Ensure content is visible */
        * {
            opacity: 1 !important;
        }
        
        /* Font sizes */
        .text-4xl, .text-5xl {
            font-size: 24px !important;
        }
        
        .text-2xl, .text-3xl {
            font-size: 18px !important;
        }
        
        .text-xl {
            font-size: 16px !important;
        }
        
        .text-lg {
            font-size: 14px !important;
        }
        
        .text-sm {
            font-size: 12px !important;
        }
        
        .font-mono {
            color: black !important;
            font-size: 12px !important;
        }
    }
    
    .print-only { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8 animate-fade-in">

    <!-- Header Section -->
    <div class="text-center mb-8">
        <div class="inline-flex items-center space-x-4 mb-6">
            <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-qrcode text-white text-3xl"></i>
            </div>
            <div class="text-left">
                <h3 class="text-3xl font-bold text-gradient">{{ subject.subject_name }}</h3>
                <div class="flex items-center space-x-3 text-slate-400 mt-1">
                    <span>{{ subject.subject_code }}</span>
                    <span>•</span>
                    <span>ปีการศึกษา {{ subject.academic_year }}</span>
                    <span>•</span>
                    <span>เทอม {{ subject.term }}</span>
                </div>
            </div>
        </div>
        <h1 class="text-5xl font-bold text-white mb-4">QR Code สำหรับเข้าสอบ</h1>
        <p class="text-xl text-slate-300">สแกน QR Code เพื่อเข้าสู่ระบบทำข้อสอบ</p>
        
        {% if subject.exam_date == today %}
            <div class="inline-flex items-center mt-4 px-4 py-2 bg-green-500/20 border border-green-500/30 rounded-full text-green-400">
                <div class="w-2 h-2 bg-green-500 rounded-full mr-2 status-badge"></div>
                <span class="font-medium">สอบวันนี้</span>
            </div>
        {% endif %}
    </div>

    <!-- QR Code Section -->
    <div class="qr-container rounded-3xl p-8 shadow-card">
        <div class="flex flex-col items-center">
            <div class="bg-white p-8 rounded-3xl mb-6 shadow-2xl">
                <img src="data:image/png;base64,{{ qr_image }}" alt="QR Code สำหรับเข้าสอบ" class="w-80 h-80">
            </div>
            
            <div class="text-center mb-6">
                <p class="text-slate-300 text-lg mb-4">สแกน QR Code ด้วยอุปกรณ์มือถือของคุณ</p>
                <div class="bg-slate-800/50 rounded-xl p-4 max-w-lg mx-auto">
                    <div class="flex items-center justify-between">
                        <span class="text-slate-300 font-mono text-sm break-all">{{ qr_url }}</span>
                        <button id="copyBtn" onclick="copyToClipboard('{{ qr_url }}')" 
                                class="ml-3 p-2 rounded-lg bg-blue-500/20 hover:bg-blue-500/30 transition-colors copy-btn"
                                title="คัดลอก URL">
                            <i class="fas fa-copy text-blue-400"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 justify-center no-print">
                <button id="shareBtn" onclick="shareQRCode()" class="action-btn btn-share">
                    <i class="fas fa-share mr-2"></i>แชร์ลิงก์
                </button>
                <a href="{% url 'exam_attendance' subject.id %}" class="action-btn btn-attendance">
                    <i class="fas fa-clipboard-check mr-2"></i>ดูการเข้าสอบ
                </a>
            </div>
        </div>
    </div>

    <!-- Exam Information with Teacher and Class Details -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Exam Details -->
        <div class="info-card rounded-2xl p-8 shadow-card">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-calendar-alt text-blue-400 text-xl"></i>
                </div>
                <h3 class="text-2xl font-semibold text-white">รายละเอียดการสอบ</h3>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">วิชา:</span>
                    <span class="text-white font-medium">{{ subject.subject_name }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">รหัสวิชา:</span>
                    <span class="text-white font-medium">{{ subject.subject_code }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">วันที่สอบ:</span>
                    <span class="text-white font-medium">{{ subject.exam_date|date:"d/m/Y" }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">เวลา:</span>
                    <span class="text-white font-medium">{{ subject.start_time|time:"H:i" }} - {{ subject.end_time|time:"H:i" }} น.</span>
                </div>
                {% if subject.room %}
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">ห้องสอบ:</span>
                    <span class="text-white font-medium">{{ subject.room.building.name }} ห้อง {{ subject.room.name }}</span>
                </div>
                {% endif %}
                <div class="flex justify-between items-center py-2">
                    <span class="text-slate-400">ระยะเวลาสอบ:</span>
                    <span class="text-white font-medium">{{ subject.get_duration }} นาที</span>
                </div>
            </div>
        </div>

        <!-- Teacher Information -->
        <div class="info-card teacher-info rounded-2xl p-8 shadow-card">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-user-tie text-purple-400 text-xl"></i>
                </div>
                <h3 class="text-2xl font-semibold text-white">ครูผู้คุมสอบ</h3>
            </div>
            <div class="space-y-4">
                {% if subject.invigilator %}
                <div class="py-3 border-b border-purple-300/20">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400">ครูหลัก:</span>
                        <span class="teacher-badge">หลัก</span>
                    </div>
                    <div class="text-white font-medium text-lg">
                        {{ subject.invigilator.user.get_full_name }}
                    </div>
                    <div class="text-slate-300 text-sm mt-1">
                        รหัสครู: {{ subject.invigilator.teacher_id }}
                    </div>
                </div>
                {% else %}
                <div class="py-3 border-b border-purple-300/20">
                    <span class="text-slate-400">ครูหลัก:</span>
                    <div class="text-orange-400 font-medium mt-1">
                        <i class="fas fa-exclamation-triangle mr-2"></i>ยังไม่ได้กำหนด
                    </div>
                </div>
                {% endif %}

                {% if subject.secondary_invigilator %}
                <div class="py-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400">ครูสำรอง:</span>
                        <span class="teacher-badge" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">สำรอง</span>
                    </div>
                    <div class="text-white font-medium text-lg">
                        {{ subject.secondary_invigilator.user.get_full_name }}
                    </div>
                    <div class="text-slate-300 text-sm mt-1">
                        รหัสครู: {{ subject.secondary_invigilator.teacher_id }}
                    </div>
                </div>
                {% else %}
                <div class="py-3">
                    <span class="text-slate-400">ครูสำรอง:</span>
                    <div class="text-slate-500 font-medium mt-1">
                        <i class="fas fa-minus mr-2"></i>ไม่มีครูสำรอง
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Class Information -->
        <div class="info-card class-info rounded-2xl p-8 shadow-card">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-graduation-cap text-green-400 text-xl"></i>
                </div>
                <h3 class="text-2xl font-semibold text-white">ข้อมูลระดับชั้น</h3>
            </div>
            <div class="space-y-4">
                {% with student_classes=subject.students.all %}
                    {% regroup student_classes by student_class as classes_grouped %}
                    {% for class_group in classes_grouped %}
                    <div class="py-3 {% if not forloop.last %}border-b border-green-300/20{% endif %}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-slate-400">ระดับชั้น:</span>
                            <span class="class-badge">{{ class_group.grouper }}</span>
                        </div>
                        <div class="text-white font-medium text-lg">
                            {{ class_group.grouper }}
                        </div>
                        <div class="text-slate-300 text-sm mt-1">
                            จำนวนนักเรียน: {{ class_group.list|length }} คน
                        </div>
                    </div>
                    {% endfor %}
                {% endwith %}
                
                <div class="py-3 mt-4 bg-green-500/10 rounded-lg p-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-400">
                            {{ subject.get_student_count }}
                        </div>
                        <div class="text-slate-300 text-sm">
                            จำนวนนักเรียนทั้งหมด
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="info-card rounded-2xl p-8 shadow-card">
        <div class="flex items-center mb-6">
            <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center mr-4">
                <i class="fas fa-info-circle text-orange-400 text-xl"></i>
            </div>
            <h3 class="text-2xl font-semibold text-white">คำแนะนำการใช้งาน</h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-slate-300">
            <div class="flex items-start space-x-3 bg-blue-500/10 p-4 rounded-lg">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                    <span class="text-white text-sm font-bold">1</span>
                </div>
                <div>
                    <p class="font-medium text-white mb-1">สำหรับนักเรียน</p>
                    <p class="text-sm">สแกน QR Code ด้วยมือถือเพื่อเช็คชื่อเข้าสอบ</p>
                </div>
            </div>
            <div class="flex items-start space-x-3 bg-green-500/10 p-4 rounded-lg">
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                    <span class="text-white text-sm font-bold">2</span>
                </div>
                <div>
                    <p class="font-medium text-white mb-1">สำหรับครู</p>
                    <p class="text-sm">สแกนเพื่อเช็คชื่อตนเองและจัดการการสอบ</p>
                </div>
            </div>
            <div class="flex items-start space-x-3 bg-yellow-500/10 p-4 rounded-lg">
                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                    <span class="text-white text-sm font-bold">!</span>
                </div>
                <div>
                    <p class="font-medium text-white mb-1">ข้อควรระวัง</p>
                    <p class="text-sm">เก็บรักษา QR Code อย่างปลอดภัย หากสูบหาย กรุณาติดต่ออาจารย์ผู้สอน</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Instructions -->
    <div class="print-only bg-white p-6 border-2 border-gray-300 rounded-lg mt-8">
        <div class="text-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">{{ subject.subject_name }}</h2>
            <p class="text-gray-600">{{ subject.subject_code }} - {{ subject.exam_date|date:"d/m/Y" }}</p>
            <p class="text-gray-600">{{ subject.start_time|time:"H:i" }} - {{ subject.end_time|time:"H:i" }} น.</p>
            {% if subject.room %}
                <p class="text-gray-600 font-semibold">{{ subject.room.building.name }} ห้อง {{ subject.room.name }}</p>
            {% endif %}
            {% if subject.invigilator %}
                <p class="text-gray-600">ครูผู้คุมสอบ: {{ subject.invigilator.user.get_full_name }}</p>
            {% endif %}
        </div>
        <div class="border-t-2 border-gray-300 pt-4">
            <p class="text-center text-gray-700 font-medium">สแกน QR Code เพื่อเข้าสู่ระบบสอบ</p>
            <p class="text-center text-gray-600 text-sm mt-2">นักเรียนและครูผู้คุมสอบ</p>
        </div>
    </div>

    <!-- Additional Actions Panel -->
    <div class="qr-actions rounded-2xl p-6 no-print">
        <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
            <div class="flex items-center space-x-3">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-slate-300">QR Code พร้อมใช้งาน</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="downloadBtn" onclick="downloadQRImage()" class="text-slate-300 hover:text-white transition-colors cursor-pointer">
                    <i class="fas fa-download mr-2"></i>ดาวน์โหลดรูป QR
                </button>
                <button onclick="refreshQRCode()" class="text-slate-300 hover:text-white transition-colors cursor-pointer">
                    <i class="fas fa-sync-alt mr-2"></i>สร้าง QR ใหม่
                </button>
            </div>
        </div>
    </div>

</div>
{% block extra_js %} {% endblock %}
<script>
// Global variables
let countdownInterval = null;
let autoRefreshInterval = null;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('QR Code page loaded successfully!');
    
    // เพิ่ม event listeners สำหรับปุ่มต่างๆ
    initializeButtons();
    
    // Setup auto refresh
    setupAutoRefresh();
    
    {% if subject.exam_date == today %}
    // Add countdown for today's exam
    addCountdownDisplay();
    {% endif %}
    
    // Check initial connectivity
    checkConnectivity();
    
    // รอให้หน้าโหลดเสร็จก่อนแสดง notification
    setTimeout(() => {
        showNotification('QR Code พร้อมใช้งาน', 'success', 3000);
    }, 500);
});

// Initialize all button event listeners
function initializeButtons() {
    console.log('Initializing button event listeners');
    
    // Copy button
    const copyBtn = document.getElementById('copyBtn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            copyToClipboard('{{ qr_url }}');
        });
    }
    
    // Print button
    const printBtn = document.getElementById('printBtn');
    if (printBtn) {
        printBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            printQRCode();
        });
    }
    
    // Share button
    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn) {
        shareBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            shareQRCode();
        });
    }
    
    // Download button
    const downloadBtn = document.getElementById('downloadBtn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            downloadQRImage();
        });
    }
    
    console.log('Button event listeners initialized');
}

// Copy URL to clipboard
function copyToClipboard(text) {
    console.log('Attempting to copy:', text);
    
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            console.log('Copy successful via clipboard API');
            showNotification('คัดลอกลิงก์แล้ว!', 'success');
            const btn = document.getElementById('copyBtn');
            if (btn) {
                btn.classList.add('copy-success');
                setTimeout(() => btn.classList.remove('copy-success'), 1000);
            }
        }).catch((err) => {
            console.error('Clipboard API failed:', err);
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    console.log('Using fallback copy method');
    try {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
            console.log('Fallback copy successful');
            showNotification('คัดลอกลิงก์แล้ว!', 'success');
            const btn = document.getElementById('copyBtn');
            if (btn) {
                btn.classList.add('copy-success');
                setTimeout(() => btn.classList.remove('copy-success'), 1000);
            }
        } else {
            throw new Error('execCommand failed');
        }
    } catch (err) {
        console.error('All copy methods failed:', err);
        showNotification('ไม่สามารถคัดลอกได้ กรุณาคัดลอกด้วยตนเอง', 'error');
    }
}

// Print QR Code
function printQRCode() {
    console.log('Print QR Code requested');
    try {
        showNotification('กำลังเตรียมการพิมพ์...', 'info');
        setTimeout(() => {
            window.print();
        }, 500);
    } catch (error) {
        console.error('Print error:', error);
        showNotification('เกิดข้อผิดพลาดในการพิมพ์', 'error');
    }
}

// Share QR Code
function shareQRCode() {
    console.log('Share QR Code requested');
    const shareData = {
        title: 'QR Code การสอบ - {{ subject.subject_name }}',
        text: 'สแกน QR Code เพื่อเข้าสู่ระบบสอบ {{ subject.subject_name }}',
        url: '{{ qr_url }}'
    };

    if (navigator.share) {
        navigator.share(shareData).then(() => {
            console.log('Share successful');
            showNotification('แชร์สำเร็จ!', 'success');
        }).catch((err) => {
            console.error('Share failed:', err);
            // Fallback to copy
            copyToClipboard('{{ qr_url }}');
        });
    } else {
        // Fallback for browsers without Web Share API
        copyToClipboard('{{ qr_url }}');
        showNotification('คัดลอกลิงก์แล้ว เนื่องจากเบราว์เซอร์ไม่รองรับการแชร์', 'info');
    }
}

// Download QR Code as image
function downloadQRImage() {
    console.log('Download QR Image requested');
    showNotification('กำลังดาวน์โหลด...', 'info');
    
    try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = document.querySelector('.qr-container img');
        
        if (!img) {
            showNotification('ไม่พบรูป QR Code', 'error');
            return;
        }
        
        // Wait for image to load if not already loaded
        if (!img.complete || img.naturalWidth === 0) {
            img.onload = function() {
                processDownload(canvas, ctx, img);
            };
            img.onerror = function() {
                showNotification('เกิดข้อผิดพลาดในการโหลดรูป', 'error');
            };
        } else {
            processDownload(canvas, ctx, img);
        }
    } catch (error) {
        console.error('Download error:', error);
        showNotification('เกิดข้อผิดพลาดในการดาวน์โหลด', 'error');
    }
}

function processDownload(canvas, ctx, img) {
    try {
        // Set canvas size to match image
        canvas.width = img.naturalWidth || 320;
        canvas.height = img.naturalHeight || 320;
        
        // Fill white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw QR code
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        // Create download link
        const link = document.createElement('a');
        link.download = 'QR_{{ subject.subject_code }}_{{ subject.exam_date|date:"Y-m-d" }}.png';
        
        // Convert canvas to blob and create URL
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            link.href = url;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            URL.revokeObjectURL(url);
            
            showNotification('ดาวน์โหลด QR Code แล้ว!', 'success');
        }, 'image/png');
        
    } catch (error) {
        console.error('Process download error:', error);
        showNotification('เกิดข้อผิดพลาดในการสร้างไฟล์', 'error');
    }
}

// Refresh QR Code
function refreshQRCode() {
    console.log('Refresh QR Code requested');
    showNotification('กำลังสร้าง QR Code ใหม่...', 'info');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Auto-refresh every 5 minutes to ensure QR code validity
function setupAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    autoRefreshInterval = setInterval(() => {
        const now = new Date();
        const examDate = new Date('{{ subject.exam_date|date:"Y-m-d" }} {{ subject.start_time }}');
        const timeDiff = examDate - now;
        
        // Refresh if exam is within 1 hour
        if (timeDiff > 0 && timeDiff < 3600000) {
            console.log('Auto-refreshing QR code...');
            showNotification('กำลังอัปเดต QR Code...', 'info');
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }, 300000); // 5 minutes
}

// Show exam countdown if exam is today
{% if subject.exam_date == today %}
function updateCountdown() {
    try {
        const examDate = new Date('{{ subject.exam_date|date:"Y-m-d" }} {{ subject.start_time }}');
        const now = new Date();
        const timeDiff = examDate - now;
        
        const countdownElement = document.getElementById('countdown');
        
        if (timeDiff > 0) {
            const hours = Math.floor(timeDiff / 3600000);
            const minutes = Math.floor((timeDiff % 3600000) / 60000);
            const seconds = Math.floor((timeDiff % 60000) / 1000);
            
            if (countdownElement) {
                countdownElement.textContent = `เหลืออีก ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // เปลี่ยนสีเมื่อเวลาใกล้หมด
                if (timeDiff < 1800000) { // น้อยกว่า 30 นาที
                    countdownElement.className = 'mt-2 text-red-400 font-mono text-sm animate-pulse';
                } else if (timeDiff < 3600000) { // น้อยกว่า 1 ชั่วโมง
                    countdownElement.className = 'mt-2 text-yellow-400 font-mono text-sm';
                } else {
                    countdownElement.className = 'mt-2 text-blue-400 font-mono text-sm';
                }
            }
        } else if (timeDiff > -10800000) { // ยังไม่เกิน 3 ชั่วโมงหลังเริ่มสอบ
            const examEndTime = new Date('{{ subject.exam_date|date:"Y-m-d" }} {{ subject.end_time }}');
            const timeToEnd = examEndTime - now;
            
            if (timeToEnd > 0 && countdownElement) {
                const endHours = Math.floor(timeToEnd / 3600000);
                const endMinutes = Math.floor((timeToEnd % 3600000) / 60000);
                countdownElement.textContent = `กำลังสอบ (เหลือ ${endHours}:${endMinutes.toString().padStart(2, '0')})`;
                countdownElement.className = 'mt-2 text-green-400 font-mono text-sm animate-pulse';
            } else if (countdownElement) {
                countdownElement.textContent = 'สอบเสร็จสิ้นแล้ว';
                countdownElement.className = 'mt-2 text-gray-400 font-mono text-sm';
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
            }
        } else if (countdownElement) {
            countdownElement.textContent = 'สอบเสร็จสิ้นแล้ว';
            countdownElement.className = 'mt-2 text-gray-400 font-mono text-sm';
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        }
    } catch (error) {
        console.error('Countdown error:', error);
    }
}

// Add countdown display
function addCountdownDisplay() {
    const statusBadge = document.querySelector('.status-badge');
    if (statusBadge) {
        const statusContainer = statusBadge.closest('.inline-flex');
        if (statusContainer && !document.getElementById('countdown')) {
            const countdownDiv = document.createElement('div');
            countdownDiv.className = 'mt-2 text-blue-400 font-mono text-sm';
            countdownDiv.id = 'countdown';
            statusContainer.appendChild(countdownDiv);
            
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }
    }
}
{% endif %}

// Keyboard shortcuts
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + P สำหรับพิมพ์
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            printQRCode();
        }
        
        // Ctrl/Cmd + C สำหรับคัดลอก URL (เมื่อไม่มี input focus)
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && 
            e.target.tagName !== 'INPUT' && 
            e.target.tagName !== 'TEXTAREA' && 
            !window.getSelection().toString()) {
            copyToClipboard('{{ qr_url }}');
        }
    });
}

// Mobile optimization
function handleMobileOptimization() {
    const isMobile = window.innerWidth <= 768;
    const qrImage = document.querySelector('.qr-container img');
    
    if (isMobile && qrImage) {
        qrImage.style.width = '250px';
        qrImage.style.height = '250px';
    }
}

// เพิ่มฟังก์ชันสำหรับตรวจสอบการเชื่อมต่ออินเทอร์เน็ต
function checkConnectivity() {
    if (!navigator.onLine) {
        showNotification('ไม่มีการเชื่อมต่ออินเทอร์เน็ต', 'warning');
    }
}

window.addEventListener('offline', () => {
    showNotification('การเชื่อมต่ออินเทอร์เน็ตขาดหาย', 'warning');
});

window.addEventListener('online', () => {
    showNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
});

// Setup keyboard shortcuts
setupKeyboardShortcuts();

// Handle mobile optimization
handleMobileOptimization();
window.addEventListener('resize', handleMobileOptimization);

// เพิ่มฟังก์ชันสำหรับ cleanup เมื่ออออกจากหน้า
window.addEventListener('beforeunload', function() {
    // ล้าง intervals
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});

// เพิ่มฟังก์ชัน utility สำหรับ debugging
window.debugQRPage = function() {
    console.log('=== QR Page Debug Info ===');
    console.log('Subject:', '{{ subject.subject_name }}');
    console.log('Exam Date:', '{{ subject.exam_date }}');
    console.log('QR URL:', '{{ qr_url }}');
    console.log('Is Today:', {% if subject.exam_date == today %}true{% else %}false{% endif %});
    console.log('Countdown Interval:', countdownInterval);
    console.log('Auto Refresh Interval:', autoRefreshInterval);
    console.log('Online Status:', navigator.onLine);
    console.log('Page Visibility:', document.hidden ? 'hidden' : 'visible');
    console.log('=========================');
};

console.log('QR Code Page Ready! Type debugQRPage() for debug info.');
</script>
{% endblock %}