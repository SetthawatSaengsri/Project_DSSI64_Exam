{% extends 'app/base.html' %}
{% load static %}

{% block title %}สแกน QR Code{% endblock %}
{% block current_page %}qr-scanner{% endblock %}
{% block page_title %}สแกน QR Code{% endblock %}
{% block page_subtitle %}สแกนเพื่อยืนยันการเข้าห้องสอบ / เช็กชื่ออัตโนมัติ{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <!-- การ์ดหลัก -->
  <div class="glass-dark rounded-3xl border border-white/20 overflow-hidden shadow-glow-purple animate-slide-up">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 p-8">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-2xl bg-white/10 flex items-center justify-center shadow-inner-glow">
          <i class="fas fa-qrcode text-white text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold font-kanit">สแกน QR Code</h2>
          <p class="text-sm text-white/80 font-prompt">จ่อ QR ไปที่กล้อง แล้วกด “เริ่มสแกน”</p>
        </div>
      </div>
    </div>

    <!-- Body -->
    <div class="p-6 lg:p-8">
      <!-- Loading -->
      <div id="loadingSpinner" class="hidden text-center py-8">
        <div class="w-12 h-12 rounded-full border-4 border-white/10 border-t-white/70 animate-spin mx-auto"></div>
        <p class="mt-4 text-slate-300">กำลังเริ่มต้นกล้อง...</p>
      </div>

      <!-- Controls -->
      <div class="glass rounded-2xl border border-white/20 p-4 lg:p-6 mb-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
          <div class="lg:col-span-2">
            <label for="cameraSelect" class="block text-sm font-semibold mb-2">
              <i class="fas fa-camera mr-2 text-slate-300"></i>เลือกกล้อง
            </label>
            <div class="relative">
              <i class="fas fa-video absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
              <select id="cameraSelect"
                      class="w-full pl-10 pr-4 py-2.5 rounded-xl bg-slate-800/60 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <option value="">กำลังโหลดรายการกล้อง...</option>
              </select>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="startButton"
                    class="flex-1 px-5 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-glow-purple transition-all">
              <i class="fas fa-play mr-2"></i>เริ่มสแกน
            </button>
            <button id="stopButton"
                    class="hidden flex-1 px-5 py-3 rounded-xl bg-gradient-to-r from-rose-500 to-red-500 hover:from-rose-600 hover:to-red-600 shadow-glow-pink transition-all">
              <i class="fas fa-stop mr-2"></i>หยุดสแกน
            </button>
          </div>
        </div>
        <div class="inline-flex items-center gap-2 text-xs mt-3 px-3 py-1.5 rounded-full bg-blue-500/20 border border-blue-400/30">
          <i class="fas fa-info-circle"></i><span>หากไม่พบกล้อง ให้ตรวจสิทธิ์การเข้าถึงในเบราว์เซอร์</span>
        </div>
      </div>

      <!-- Scanner -->
      <div id="reader" class="rounded-2xl overflow-hidden bg-slate-800/60 border border-white/10 mb-6"></div>

      <!-- Result -->
      <div class="glass rounded-2xl border border-white/20 p-5">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
          <i class="fas fa-clipboard-check text-slate-300"></i>ผลการสแกน
        </h3>
        <div id="result"
             class="min-h-[84px] rounded-xl border border-white/10 bg-slate-900/60 p-4 flex items-center justify-center text-slate-300 text-sm">
          <span class="opacity-70"><i class="fas fa-hourglass-half mr-2"></i>รอการสแกน...</span>
        </div>
        <div id="alertContainer" class="mt-3"></div>
      </div>

      <!-- Stats -->
      <div id="statsGrid" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
        <div class="rounded-2xl p-5 text-center bg-gradient-to-r from-indigo-500 to-purple-600">
          <i class="fas fa-check-circle text-white/90 text-2xl"></i>
          <div id="successCount" class="text-3xl font-extrabold mt-2">0</div>
          <div class="text-white/80 text-sm">สแกนสำเร็จ</div>
        </div>
        <div class="rounded-2xl p-5 text-center bg-gradient-to-r from-cyan-500 to-blue-600">
          <i class="fas fa-clock text-white/90 text-2xl"></i>
          <div id="scanTime" class="text-3xl font-extrabold mt-2">-</div>
          <div class="text-white/80 text-sm">เวลาล่าสุด</div>
        </div>
      </div>
    </div>
  </div>

  <noscript>
    <div class="mt-6 p-4 rounded-xl bg-red-500/20 border border-red-400/40 text-red-200">
      จำเป็นต้องเปิดใช้งาน JavaScript เพื่อสแกน QR Code
    </div>
  </noscript>
</div>
{% endblock %}

{% block extra_js %}
<!-- html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  let html5QrCode;
  let isScanning = false;
  let successCount = 0;

  // ป้องกัน "สแกนรัวๆ" — ให้ทำงานครั้งแรกครั้งเดียวต่อการเริ่มสแกน
  let hasHandledFirstScan = false;

  // ป้องกัน initialize ซ้ำ หาก base.html เรียก initializePage ให้อัตโนมัติ
  let qrPageInitialized = false;

  function pageNotify(msg, type='info') {
    // ใช้ระบบแจ้งเตือนกลางของ base.html ถ้ามี
    if (typeof showNotification === 'function') {
      showNotification(msg, type);
    } else {
      const box = document.createElement('div');
      box.className = 'mt-3 px-4 py-3 rounded-xl ' +
        (type==='success' ? 'bg-green-500/20 border border-green-400/40' :
         type==='error'   ? 'bg-red-500/20 border border-red-400/40'   :
         type==='warning' ? 'bg-yellow-500/20 border border-yellow-400/40' :
                            'bg-blue-500/20 border border-blue-400/40');
      box.textContent = msg;
      document.getElementById('alertContainer').appendChild(box);
      setTimeout(()=> box.remove(), 4000);
    }
  }

  function showLoading(show) {
    document.getElementById('loadingSpinner').classList.toggle('hidden', !show);
  }

  function updateStats() {
    const now = new Date();
    document.getElementById('successCount').textContent = successCount;
    document.getElementById('scanTime').textContent = now.toLocaleTimeString('th-TH');
    document.getElementById('statsGrid').classList.remove('hidden');
  }

  // แปลงข้อความจาก QR ให้เป็น URL ที่ปลอดภัย (อนุญาตเฉพาะ http/https หรือ path ภายในระบบ)
  function resolveUrl(raw) {
    const t = (raw || '').trim();
    if (!t) return null;
    // กัน schema อันตราย
    if (/^(javascript|data):/i.test(t)) return null;
    // อนุญาต http/https หรือ path ในแอป
    if (/^https?:\/\//i.test(t) || t.startsWith('/')) return t;
    // กรณีส่งเป็น path แบบไม่มี "/" นำหน้า เช่น "student/checkin?token=..."
    return '/' + t;
  }

  // เรียกเมื่อสแกนสำเร็จ: หยุดกล้องและนำทางทันที (กันสแกนซ้ำด้วย hasHandledFirstScan)
  async function onScanSuccess(decodedText, decodedResult) {
    if (hasHandledFirstScan) return;
    hasHandledFirstScan = true;

    const url = resolveUrl(decodedText);
    if (!url) {
      hasHandledFirstScan = false; // ปลดล็อกให้สแกนใหม่ได้
      pageNotify('ข้อมูลที่สแกนไม่ใช่ลิงก์ที่รองรับ', 'warning');
      document.getElementById('result').textContent = decodedText;
      return;
    }

    successCount++;
    updateStats();
    document.getElementById('result').innerHTML =
      `<div class="text-green-400"><i class="fas fa-check-circle mr-2"></i>พบลิงก์</div>
       <div class="mt-2 break-words">${url}</div>`;
    pageNotify('กำลังเปิดลิงก์ที่สแกน...', 'success');

    try {
      await stopScanning(); // หยุดกล้องเพื่อกัน callback ซ้ำ
    } catch (e) { /* ignore */ }

    // ไปยังลิงก์นั้นทันที
    window.location.assign(url);
  }

  function onScanError(errorMessage) {
    // เงียบไว้เพื่อลด spam ในคอนโซล
    // console.log('Scan error:', errorMessage);
  }

  async function startScanning() {
    const cameraId = document.getElementById('cameraSelect').value;
    if (!cameraId) {
      pageNotify('กรุณาเลือกกล้องก่อนเริ่มสแกน', 'warning');
      return;
    }
    showLoading(true);
    try {
      // รีเซ็ตตัวล็อกเมื่อเริ่มสแกนใหม่
      hasHandledFirstScan = false;

      await html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 280, height: 280 } },
        onScanSuccess,
        onScanError
      );
      isScanning = true;
      document.getElementById('startButton').classList.add('hidden');
      document.getElementById('stopButton').classList.remove('hidden');
      document.getElementById('cameraSelect').disabled = true;
      pageNotify('เริ่มสแกนแล้ว', 'success');
    } catch (err) {
      pageNotify(`ไม่สามารถเริ่มกล้องได้: ${err}`, 'error');
      console.error(err);
    } finally {
      showLoading(false);
    }
  }

  async function stopScanning() {
    if (!isScanning) return;
    await html5QrCode.stop();
    isScanning = false;
    document.getElementById('startButton').classList.remove('hidden');
    document.getElementById('stopButton').classList.add('hidden');
    document.getElementById('cameraSelect').disabled = false;
  }

  // ให้ base.html เรียกหลัง DOM พร้อม (ผ่าน initializePage) + มีตัวกันซ้ำ
  function initializePage() {
    if (qrPageInitialized) return;
    qrPageInitialized = true;

    html5QrCode = new Html5Qrcode('reader');

    // โหลดรายชื่อกล้อง
    Html5Qrcode.getCameras().then(devices => {
      const select = document.getElementById('cameraSelect');
      select.innerHTML = '';
      if (devices && devices.length) {
        devices.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.text = d.label || `กล้อง ${i+1}`;
          select.appendChild(opt);
        });
      } else {
        select.innerHTML = '<option value="">ไม่พบกล้อง</option>';
        pageNotify('ไม่พบกล้องในอุปกรณ์', 'warning');
      }
    }).catch(err => {
      pageNotify('ไม่สามารถเข้าถึงกล้องได้ กรุณาอนุญาตการเข้าถึง', 'error');
      console.error(err);
    });

    document.getElementById('startButton').addEventListener('click', startScanning);
    document.getElementById('stopButton').addEventListener('click', stopScanning);
  }

  // ให้ base.html เรียก initializePage() ได้
  window.initializePage = initializePage;

  // สำรอง: หาก base ไม่ได้เรียก ออโต้ทำงานเมื่อ DOM พร้อม
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof initializePage === 'function') initializePage();
  });

  // ปิดกล้องเมื่อเปลี่ยนหน้า
  window.addEventListener('beforeunload', () => {
    if (isScanning && html5QrCode) html5QrCode.stop();
  });
</script>
{% endblock %}
